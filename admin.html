<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Management — Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <script>
        // Immediate Theme Check (Prevents Flicker)
        (function () {
            const user = JSON.parse(localStorage.getItem('office_hub_user') || '{}');
            const theme = user.companies?.theme_id || 'theme-1';
            const colors = {
                'theme-1': { primary: '#6c63ff', accent: '#2dd4bf', bg: '#0d0d1a' },
                'theme-2': { primary: '#38bdf8', accent: '#818cf8', bg: '#020617' },
                'theme-3': { primary: '#34d399', accent: '#059669', bg: '#064e3b' },
                'theme-4': { primary: '#f87171', accent: '#b91d1d', bg: '#450a0a' },
                'theme-5': { primary: '#0ea5e9', accent: '#2dd4bf', bg: '#0c4a6e' },
                'theme-6': { primary: '#f43f5e', accent: '#fb923c', bg: '#500724' },
                'theme-7': { primary: '#a855f7', accent: '#ec4899', bg: '#4c0519' },
                'theme-8': { primary: '#00ffcc', accent: '#ff00ff', bg: '#1a1a2e' },
                'theme-9': { primary: '#4ade80', accent: '#15803d', bg: '#052e16' },
                'theme-10': { primary: '#94a3b8', accent: '#3b82f6', bg: '#0f172a' }
            };
            const c = colors[theme] || colors['theme-1'];
            document.documentElement.style.setProperty('--primary', c.primary);
            document.documentElement.style.setProperty('--accent', c.accent);
            document.documentElement.style.setProperty('--bg', c.bg);
            document.write('<style id="early-theme">body{background:' + c.bg + '!important;}</style>');
        })();
    </script>
    <style>
        :root {
            --primary: #6c63ff;
            --accent: #2dd4bf;
            --bg: #0d0d1a;
        }

        * {
            box-sizing: border-box
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0d0d1a;
            color: #e2e8f0;
            margin: 0
        }

        #sidebar {
            width: 260px;
            min-height: 100vh;
            background: linear-gradient(180deg, #12122a 0%, #0d0d1a 100%);
            border-right: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 40;
            transition: transform 0.3s
        }

        #main {
            margin-left: 260px;
            min-height: 100vh;
            transition: margin-left 0.3s
        }

        .bulk-bar {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(13, 13, 26, 0.9);
            border: 1px solid rgba(108, 99, 255, 0.3);
            padding: 0.75rem 1.5rem;
            border-radius: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            z-index: 1000;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            visibility: hidden;
            opacity: 0;
        }

        .bulk-bar.show {
            transform: translateX(-50%) translateY(0);
            visibility: visible;
            opacity: 1;
        }

        .custom-check {
            width: 18px;
            height: 18px;
            border-radius: 6px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            flex-shrink: 0;
        }

        .custom-check.active {
            background: #6c63ff;
            border-color: #6c63ff;
        }

        .custom-check.active::after {
            content: '✓';
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
        }

        .bulk-item-check {
            accent-color: #6c63ff;
            cursor: pointer;
        }

        @media(max-width:768px) {
            #sidebar {
                transform: translateX(-260px)
            }

            #sidebar.open {
                transform: translateX(0)
            }

            #main {
                margin-left: 0
            }

            #overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.6);
                z-index: 35;
                display: none
            }

            #overlay.show {
                display: block
            }
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 11px 20px;
            border-radius: 12px;
            margin: 2px 10px;
            color: rgba(255, 255, 255, 0.55);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none
        }

        .nav-item:hover {
            background: rgba(108, 99, 255, 0.12);
            color: #fff
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(108, 99, 255, 0.25), rgba(79, 70, 229, 0.15));
            color: #a5b4fc
        }

        .nav-item svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0
        }

        .card {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.07);
            border-radius: 20px;
            padding: 24px
        }

        .section {
            display: none
        }

        /* Clock widget / Photo Actions */
        .clock-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 14px 28px;
            border-radius: 14px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            gap: 8px;
        }

        .btn-in {
            background: linear-gradient(135deg, #10b981, #059669);
            color: #fff;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.35);
        }

        .btn-in:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(16, 185, 129, 0.45);
        }

        .btn-brk {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #fff;
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.35);
        }

        .btn-brk:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(245, 158, 11, 0.45);
        }

        .btn-out {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: #fff;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.35);
        }

        .btn-out:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(239, 68, 68, 0.45);
        }

        .section.active {
            display: block
        }

        .btn {
            padding: 9px 20px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            border: none;
            transition: all 0.2s
        }

        .btn-primary {
            background: linear-gradient(135deg, #6c63ff, #4f46e5);
            color: #fff;
            box-shadow: 0 4px 16px rgba(108, 99, 255, 0.35)
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 24px rgba(108, 99, 255, 0.45)
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3)
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.25)
        }

        .btn-sm {
            padding: 6px 14px;
            font-size: 12px
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 4px
        }

        th {
            text-align: left;
            padding: 8px 14px;
            color: rgba(255, 255, 255, 0.35);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: .08em;
            font-weight: 600
        }

        td {
            padding: 12px 14px;
            background: rgba(255, 255, 255, 0.03);
            font-size: 13px;
            vertical-align: middle
        }

        td:first-child {
            border-radius: 10px 0 0 10px
        }

        td:last-child {
            border-radius: 0 10px 10px 0
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.05)
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600
        }

        .badge-in {
            background: rgba(16, 185, 129, 0.15);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3)
        }

        .badge-break {
            background: rgba(245, 158, 11, 0.15);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.3)
        }

        .badge-out {
            background: rgba(100, 116, 139, 0.15);
            color: #94a3b8;
            border: 1px solid rgba(100, 116, 139, 0.3)
        }

        .badge-admin {
            background: rgba(168, 85, 247, 0.15);
            color: #c4b5fd;
            border: 1px solid rgba(168, 85, 247, 0.3)
        }

        .badge-staff {
            background: rgba(14, 165, 233, 0.15);
            color: #7dd3fc;
            border: 1px solid rgba(14, 165, 233, 0.3)
        }

        .input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            border-radius: 12px;
            padding: 10px 16px;
            font-size: 14px;
            width: 100%;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Override Browser Autofill Styles */
        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus,
        input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 1000px #1a1a2e inset !important;
            -webkit-text-fill-color: #fff !important;
            transition: background-color 5000s ease-in-out 0s;
        }

        .input:focus {
            outline: none;
            border-color: #6c63ff;
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.15);
        }

        .camera-view {
            width: 100%;
            aspect-ratio: 4/3;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        #camera-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        .img-preview-mod {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #6c63ff;
            margin: 0 auto;
            display: block;
        }

        .input::placeholder {
            color: rgba(255, 255, 255, 0.3)
        }

        .modal-bg {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 16px
        }

        .modal-bg.show {
            display: flex
        }

        .modal {
            background: #1a1a2e;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 28px;
            width: 100%;
            max-width: 440px
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6c63ff, #2dd4bf);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #fff;
            font-size: 13px;
            flex-shrink: 0
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.07);
            border-radius: 16px;
            padding: 20px
        }

        ::-webkit-scrollbar {
            width: 5px
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px
        }

        .fade-in {
            animation: fadeIn 0.4s ease both
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .pulse-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 1.8s infinite
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1)
            }

            50% {
                opacity: .4;
                transform: scale(0.8)
            }
        }

        select.input option {
            background: #1e1e3a
        }

        .post-card {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.07);
            border-radius: 16px;
            padding: 18px;
            transition: border-color 0.2s
        }

        .post-card:hover {
            border-color: rgba(108, 99, 255, 0.2)
        }

        .like-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.04);
            color: rgba(255, 255, 255, 0.45);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s
        }

        .like-btn:hover {
            border-color: rgba(239, 68, 68, 0.4);
            color: #f87171;
            background: rgba(239, 68, 68, 0.08)
        }

        .like-btn.liked {
            border-color: rgba(239, 68, 68, 0.5);
            color: #f87171;
            background: rgba(239, 68, 68, 0.12)
        }

        .comment-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 8px 12px;
            color: #fff;
            font-size: 13px;
            width: 100%;
            outline: none;
            transition: border-color 0.2s
        }

        .comment-input:focus {
            border-color: #6c63ff
        }

        .comment-input::placeholder {
            color: rgba(255, 255, 255, 0.3)
        }

        .notif-preview {
            cursor: pointer;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.07);
            border-radius: 14px;
            padding: 16px;
            transition: all 0.2s
        }

        /* ── Multi-Staff Picker ── */
        .staff-picker {
            position: relative;
        }

        .staff-picker-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 10px;
            padding: 10px 14px;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            transition: border-color 0.2s;
            text-align: left;
        }

        .staff-picker-btn:focus,
        .staff-picker-btn.open {
            outline: none;
            border-color: #6c63ff;
            box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.15);
        }

        .staff-picker-chevron {
            flex-shrink: 0;
            transition: transform 0.2s;
        }

        .staff-picker-btn.open .staff-picker-chevron {
            transform: rotate(180deg);
        }

        .staff-picker-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            right: 0;
            background: #1a1a2e;
            border: 1px solid rgba(108, 99, 255, 0.35);
            border-radius: 12px;
            z-index: 200;
            max-height: 220px;
            overflow-y: auto;
            padding: 6px 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .staff-picker-dropdown.open {
            display: block;
        }

        .sp-search {
            margin: 6px 10px 8px;
            padding: 7px 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 12px;
            width: calc(100% - 20px);
        }

        .sp-search:focus {
            outline: none;
            border-color: #6c63ff;
        }

        .sp-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 14px;
            cursor: pointer;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.75);
            transition: background 0.15s;
        }

        .sp-item:hover {
            background: rgba(108, 99, 255, 0.12);
            color: #fff;
        }

        .sp-item input[type=checkbox] {
            accent-color: #6c63ff;
            width: 15px;
            height: 15px;
            flex-shrink: 0;
            cursor: pointer;
        }

        .sp-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(108, 99, 255, 0.2);
            border: 1px solid rgba(108, 99, 255, 0.3);
            color: #a5b4fc;
            border-radius: 20px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 600;
            flex-shrink: 0;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0) scale(1);
            }

            50% {
                transform: translateY(-30px) scale(1.05);
            }
        }

        .orb-bg {
            position: fixed;
            inset: 0;
            overflow: hidden;
            pointer-events: none;
            z-index: -1;
            display: none;
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.25;
            animation: float 8s ease-in-out infinite;
        }

        .orb-1 {
            width: 600px;
            height: 600px;
            background: var(--primary);
            top: -200px;
            left: -200px;
        }

        .orb-2 {
            width: 500px;
            height: 500px;
            background: var(--accent);
            bottom: -150px;
            right: -150px;
            animation-delay: -4s;
        }

        .orb-3 {
            width: 400px;
            height: 400px;
            background: #f472b6;
            top: 40%;
            left: 30%;
            animation-delay: -2s;
            opacity: 0.15;
        }

        .with-orbs .orb-bg {
            display: block;
        }

        .with-orbs #sidebar,
        .with-orbs .stat-card,
        .with-orbs .card {
            backdrop-filter: blur(16px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #4f46e5) !important;
            box-shadow: 0 4px 15px var(--primary)44 !important;
        }

        .nav-item.active {
            background: var(--primary)1a !important;
            color: var(--primary) !important;
        }

        .text-violet-400 {
            color: var(--primary) !important;
        }

        .bg-violet-500\/15 {
            background: var(--primary)1a !important;
            color: var(--primary) !important;
            border-color: var(--primary)33 !important;
        }

        .notif-preview:hover {
            border-color: var(--primary) !important;
        }

        textarea.input {
            resize: vertical;
            min-height: 90px
        }

        /* ── Staff Detail Flyout Panel ── */
        #staff-detail-panel {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 340px;
            max-width: 95vw;
            background: linear-gradient(160deg, #1a1a2e 0%, #13132a 100%);
            border-left: 1px solid rgba(108, 99, 255, 0.2);
            z-index: 500;
            transform: translateX(110%);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: -8px 0 40px rgba(0, 0, 0, 0.5);
        }

        #staff-detail-panel.open {
            transform: translateX(0);
        }

        #staff-detail-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(3px);
            z-index: 499;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        #staff-detail-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }

        .sdp-header {
            background: linear-gradient(135deg, rgba(108, 99, 255, 0.2), rgba(45, 212, 191, 0.1));
            border-bottom: 1px solid rgba(255, 255, 255, 0.07);
            padding: 20px 20px 24px;
            position: relative;
        }

        .sdp-avatar {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            background: linear-gradient(135deg, #6c63ff, #2dd4bf);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 700;
            color: #fff;
            border: 3px solid rgba(255, 255, 255, 0.12);
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(108, 99, 255, 0.3);
            flex-shrink: 0;
        }

        .sdp-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .sdp-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .sdp-row {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .sdp-row:last-child {
            border-bottom: none;
        }

        .sdp-icon {
            width: 32px;
            height: 32px;
            border-radius: 9px;
            background: rgba(108, 99, 255, 0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 14px;
        }

        .sdp-label {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.35);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .sdp-value {
            font-size: 14px;
            color: #fff;
            font-weight: 500;
            word-break: break-all;
        }

        .sdp-value.muted {
            color: rgba(255, 255, 255, 0.5);
            font-weight: 400;
        }

        .sdp-footer {
            padding: 16px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.07);
            display: flex;
            gap: 10px;
        }

        tr.staff-row {
            cursor: pointer;
            transition: background 0.15s;
        }

        tr.staff-row:hover {
            background: rgba(108, 99, 255, 0.06);
        }

        .seen-pill {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(108, 99, 255, 0.12);
            color: #a5b4fc;
            border: 1px solid rgba(108, 99, 255, 0.25);
            border-radius: 20px;
            padding: 3px 10px;
            font-size: 11px;
            font-weight: 600
        }

        .composer-area {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            padding: 14px;
            color: #fff;
            font-size: 14px;
            width: 100%;
            resize: none;
            transition: border-color 0.2s;
            min-height: 80px
        }

        .composer-area:focus {
            outline: none;
            border-color: #6c63ff
        }

        .btn-post {
            background: #6c63ff;
            color: #fff;
            font-weight: 600;
            padding: 10px 24px;
            border-radius: 12px;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(108, 99, 255, 0.25)
        }

        .btn-post:hover {
            opacity: 0.9;
            transform: translateY(-1px)
        }

        .btn-post:disabled {
            opacity: 0.5;
            cursor: not-allowed
        }
    </style>
</head>

<body>
    <div id="overlay" onclick="closeSidebar()"></div>

    <div class="orb-bg">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    <!-- SIDEBAR -->
    <aside id="sidebar">
        <div class="px-4 py-4 border-b border-white/5">
            <div class="flex items-center gap-3">
                <div id="sb-avatar" class="avatar">—</div>
                <div>
                    <div id="sb-name" class="text-white font-semibold text-sm truncate">Loading…</div>
                    <div id="sb-company" class="text-violet-400 text-xs font-medium">Admin</div>
                </div>
            </div>
        </div>
        <nav class="flex-1 py-4 overflow-y-auto">
            <div class="px-4 mb-2 text-white/25 text-xs font-semibold uppercase tracking-widest">Management</div>
            <div class="nav-item active" onclick="show('dash')" id="nav-dash"><svg fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 5a1 1 0 011-1h4a1 1 0 011 1v5a1 1 0 01-1 1H5a1 1 0 01-1-1V5zm10 0a1 1 0 011-1h4a1 1 0 011 1v2a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zm10-3a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1h-4a1 1 0 01-1-1v-7z" />
                </svg>Dashboard</div>
            <div class="nav-item" onclick="show('staff')" id="nav-staff"><svg fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>Staff Management</div>
            <div class="nav-item" onclick="show('attend')" id="nav-attend"><svg fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                </svg>Attendance Monitor</div>
            <div class="nav-item" onclick="show('notifs')" id="nav-notifs"><svg fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                </svg>Notifications</div>
            <div class="nav-item" onclick="show('wall')" id="nav-wall"><svg fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
                </svg>Social Wall</div>
            <div class="nav-item" onclick="show('reports')" id="nav-reports"><svg fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>Reports &amp; CSV</div>
            <div class="nav-item" onclick="show('sub')" id="nav-sub"><svg fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>Subscription</div>
            <div class="nav-item" onclick="show('settings')" id="nav-settings"><svg fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>Company Settings</div>
            <div class="nav-item" onclick="show('profile')" id="nav-profile">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>My Profile
            </div>
        </nav>
        <div id="stop-imp-btn" class="hidden p-4 border-t border-emerald-500/20">
            <button onclick="stopImpersonating()"
                class="nav-item w-full text-emerald-400 hover:bg-emerald-500/10 hover:text-emerald-300 font-bold">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 0118 0z" />
                </svg>
                Exit View Mode
            </button>
        </div>
        <div class="p-4 border-t border-white/5">
            <button onclick="logout()" class="nav-item w-full text-red-400 hover:bg-red-500/10 hover:text-red-300"><svg
                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>Sign Out</button>
        </div>
    </aside>

    <!-- MAIN -->
    <main id="main">
        <!-- Topbar -->
        <div id="top-bar"
            class="sticky top-0 z-30 bg-[#0d0d1a]/90 backdrop-blur border-b border-white/5 px-4 sm:px-6 py-3 flex items-center gap-4">
            <button onclick="toggleSidebar()"
                class="w-9 h-9 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-all md:hidden">
                <svg class="w-5 h-5 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
            <h1 id="page-title" class="text-white font-semibold text-base sm:text-lg">Dashboard</h1>
            <span id="company-tag"
                class="ml-2 hidden sm:inline text-xs bg-violet-500/15 text-violet-300 border border-violet-500/25 px-3 py-1 rounded-full"></span>
            <div class="ml-auto text-white/40 text-sm hidden sm:block" id="topbar-time"></div>
        </div>

        <div class="p-4 sm:p-6 lg:p-8 max-w-6xl mx-auto space-y-6">

            <!-- ── DASHBOARD ── -->
            <div id="section-dash" class="section active fade-in">
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <div class="stat-card">
                        <div class="text-white/40 text-xs mb-2">Total Staff</div>
                        <div id="stat-staff" class="text-3xl font-bold text-white">—</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-white/40 text-xs mb-2">Clocked In</div>
                        <div id="stat-in" class="text-3xl font-bold text-emerald-400">—</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-white/40 text-xs mb-2">On Break</div>
                        <div id="stat-break" class="text-3xl font-bold text-amber-400">—</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-white/40 text-xs mb-2">Posts Today</div>
                        <div id="stat-posts" class="text-3xl font-bold text-violet-400">—</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-white/40 text-xs mb-2">Avg. Work (Today)</div>
                        <div id="stat-avg-work" class="text-3xl font-bold text-emerald-400">—</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-white/40 text-xs mb-2">Avg. Break (Today)</div>
                        <div id="stat-avg-break" class="text-3xl font-bold text-amber-400">—</div>
                    </div>
                </div>

                <!-- ── TOP 5 RANKINGS ── -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
                    <div class="card flex flex-col h-[300px]">
                        <div class="flex items-center justify-between mb-4 flex-shrink-0">
                            <h3 class="text-white font-semibold text-sm">Top 5: Most Work</h3>
                            <button onclick="openTopModal('work')"
                                class="text-emerald-400 text-[11px] hover:underline px-2 py-1 bg-emerald-400/10 rounded-md transition-colors hover:bg-emerald-400/20">See
                                All</button>
                        </div>
                        <div id="top5-work" class="space-y-2 overflow-y-auto pr-2 custom-scrollbar flex-1">
                            <div class="text-white/40 text-xs text-center py-4">Loading…</div>
                        </div>
                    </div>
                    <div class="card flex flex-col h-[300px]">
                        <div class="flex items-center justify-between mb-4 flex-shrink-0">
                            <h3 class="text-white font-semibold text-sm">Top 5: Most Break</h3>
                            <button onclick="openTopModal('break-most')"
                                class="text-amber-400 text-[11px] hover:underline px-2 py-1 bg-amber-400/10 rounded-md transition-colors hover:bg-amber-400/20">See
                                All</button>
                        </div>
                        <div id="top5-break-most" class="space-y-2 overflow-y-auto pr-2 custom-scrollbar flex-1">
                            <div class="text-white/40 text-xs text-center py-4">Loading…</div>
                        </div>
                    </div>
                    <div class="card flex flex-col h-[300px]">
                        <div class="flex items-center justify-between mb-4 flex-shrink-0">
                            <h3 class="text-white font-semibold text-sm">Top 5: Least Break</h3>
                            <button onclick="openTopModal('break-least')"
                                class="text-sky-400 text-[11px] hover:underline px-2 py-1 bg-sky-400/10 rounded-md transition-colors hover:bg-sky-400/20">See
                                All</button>
                        </div>
                        <div id="top5-break-least" class="space-y-2 overflow-y-auto pr-2 custom-scrollbar flex-1">
                            <div class="text-white/40 text-xs text-center py-4">Loading…</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ── STAFF ── -->
            <div id="section-staff" class="section fade-in space-y-4">
                <div class="flex items-center justify-between flex-wrap gap-3">
                    <h2 class="text-white font-semibold">Staff Members</h2>
                    <div class="flex items-center gap-2">
                        <button onclick="exportStaffCSV()" class="btn btn-sm flex items-center gap-2"
                            style="background:rgba(255,255,255,0.1);color:#fff" title="Export Staff List to CSV">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Export CSV
                        </button>
                        <button onclick="openAddStaff()" class="btn btn-primary flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4" />
                            </svg>Add Staff
                        </button>
                    </div>
                </div>
                <div class="card overflow-x-auto">
                    <table>
                        <thead>
                            <tr>
                                <th class="w-10"><input type="checkbox" id="staff-select-all"
                                        onclick="toggleAll('staff')" class="bulk-item-check"></th>
                                <th>Name</th>
                                <th>Username</th>
                                <th>Role</th>
                                <th>Salary</th>
                                <th>Duty</th>
                                <th>Joined</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="staff-body">
                            <tr>
                                <td colspan="7" class="text-center text-white/40 py-4">Loading…</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ── ATTENDANCE MONITOR ── -->
            <div id="section-attend" class="section fade-in space-y-4">
                <div class="flex items-center justify-between flex-wrap gap-3">
                    <div class="flex items-center gap-3">
                        <h2 class="text-white font-semibold">Live Attendance Monitor</h2>
                        <span class="flex items-center gap-2 text-xs text-emerald-400"><span class="pulse-dot"
                                style="background:#10b981"></span>Real-time</span>
                    </div>
                    <button onclick="exportAttendCSV()" class="btn btn-sm flex items-center gap-2"
                        style="background:rgba(255,255,255,0.1);color:#fff" title="Export Live Attendance to CSV">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Export CSV
                    </button>
                </div>
                <div class="card overflow-x-auto">
                    <table>
                        <thead>
                            <tr>
                                <th>Staff</th>
                                <th>In Time</th>
                                <th>Out Time</th>
                                <th>Work Today</th>
                                <th>Break Today</th>
                                <th>IP Address</th>
                                <th>Location</th>
                            </tr>
                        </thead>
                        <tbody id="attend-body">
                            <tr>
                                <td colspan="5" class="text-center text-white/40 py-4">Loading…</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ── NOTIFICATIONS ── -->
            <div id="section-notifs" class="section fade-in space-y-6">
                <div class="card space-y-4">
                    <h2 class="text-white font-semibold">Send New Notification</h2>
                    <div class="space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-white/40 text-xs mb-1 block">Recipient(s)</label>
                                <div class="staff-picker" id="notif-target-picker">
                                    <button type="button" class="staff-picker-btn" id="notif-picker-btn"
                                        onclick="toggleStaffPicker('notif')">
                                        <span id="notif-picker-label">Company Wide (All Staff)</span>
                                        <svg class="staff-picker-chevron w-4 h-4 text-white/40" fill="none"
                                            stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>
                                    <div class="staff-picker-dropdown" id="notif-picker-dropdown">
                                        <input type="text" class="sp-search" placeholder="Search staff…"
                                            oninput="filterStaffPicker('notif', this.value)" />
                                        <div id="notif-picker-list">
                                            <label class="sp-item">
                                                <input type="checkbox" id="notif-chk-all" value="all"
                                                    onchange="onStaffPickerAll('notif', this)" checked />
                                                Company Wide (All Staff)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="text-white/40 text-xs mb-1 block">Title</label>
                                <input id="notif-title" type="text" class="input" placeholder="Notification title…" />
                            </div>
                        </div>

                        <label class="text-white/40 text-xs mb-1 block">Message</label>
                        <textarea id="notif-body" class="input" placeholder="Message body…" rows="3"></textarea>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-white/40 text-xs mb-1 block">Attachment Type</label>
                                <select id="notif-att-type" class="input">
                                    <option value="">No Attachment</option>
                                    <option value="image">Image (Upload/Link)</option>
                                    <option value="link">Web Link</option>
                                    <option value="file">File (Upload/Link)</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-white/40 text-xs mb-1 block">Attachment URL / File</label>
                                <div class="flex gap-2">
                                    <input id="notif-att-url" type="text" class="input flex-1"
                                        placeholder="https://…" />
                                    <button class="btn btn-sm bg-white/10"
                                        onclick="document.getElementById('notif-file-input').click()">Upload</button>
                                </div>
                                <input type="file" id="notif-file-input" class="hidden"
                                    onchange="uploadNotifFile(this)" />
                            </div>
                        </div>

                        <button onclick="sendNotif()" class="btn btn-primary w-full md:w-auto">Send
                            Notification</button>
                        <div id="notif-msg" class="hidden text-sm text-emerald-400"></div>
                    </div>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
                        <div class="flex items-center gap-4">
                            <h2 class="text-white font-semibold">Sent Notifications</h2>
                            <div class="flex items-center gap-2">
                                <select id="notif-filter" class="input py-1 text-xs w-auto bg-white/5 border-white/10"
                                    onchange="loadNotifs()">
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="year">This Year</option>
                                    <option value="custom">Custom Range</option>
                                    <option value="all">All Time</option>
                                </select>
                                <div id="notif-custom-dates" class="hidden flex items-center gap-2">
                                    <input type="date" id="notif-start"
                                        class="input py-1 text-xs w-28 bg-white/5 border-white/10"
                                        onchange="loadNotifs()" />
                                    <span class="text-white/30 text-xs">-</span>
                                    <input type="date" id="notif-end"
                                        class="input py-1 text-xs w-28 bg-white/5 border-white/10"
                                        onchange="loadNotifs()" />
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 text-xs text-white/40">
                            <input type="checkbox" id="notifs-select-all" onclick="toggleAll('notifs')"
                                class="bulk-item-check">
                            <label for="notifs-select-all" class="cursor-pointer">Select All</label>
                        </div>
                    </div>
                    <div id="notif-list" class="space-y-3">
                        <div class="text-white/40 text-sm">Loading…</div>
                    </div>
                </div>
            </div>

            <!-- ── SOCIAL WALL (ADMIN) ── -->
            <div id="section-wall" class="section fade-in space-y-4">
                <div class="flex items-center justify-between flex-wrap gap-3">
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <h2 class="text-white font-semibold">Social Wall</h2>
                            <span class="text-xs text-white/40 bg-white/5 px-3 py-1 rounded-full text-nowrap">Admin
                                control</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <select id="wall-filter" class="input py-1 text-xs w-auto bg-white/5 border-white/10"
                                onchange="loadWall()">
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="year">This Year</option>
                                <option value="custom">Custom Range</option>
                                <option value="all">All Time</option>
                            </select>
                            <div id="wall-custom-dates" class="hidden flex items-center gap-2">
                                <input type="date" id="wall-start"
                                    class="input py-1 text-xs w-28 bg-white/5 border-white/10" onchange="loadWall()" />
                                <span class="text-white/30 text-xs">-</span>
                                <input type="date" id="wall-end"
                                    class="input py-1 text-xs w-28 bg-white/5 border-white/10" onchange="loadWall()" />
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 text-xs text-white/40">
                        <input type="checkbox" id="wall-select-all" onclick="toggleAll('wall')" class="bulk-item-check">
                        <label for="wall-select-all" class="cursor-pointer">Select All</label>
                    </div>
                </div>
                <!-- Admin Post Composer -->
                <div class="card space-y-4">
                    <div class="flex items-start gap-3">
                        <div id="composer-avatar" class="avatar text-sm">—</div>
                        <textarea id="post-content" class="composer-area flex-1"
                            placeholder="What's the latest update for the office?"></textarea>
                    </div>
                    <div class="flex items-center justify-between flex-wrap gap-3">
                        <div class="flex items-center gap-3">
                            <label for="post-image"
                                class="flex items-center gap-2 cursor-pointer text-sm text-white/50 hover:text-white/80 transition-colors bg-white/5 px-3 py-2 border border-white/10"
                                style="border-radius:10px">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg> Photo
                            </label>
                            <input id="post-image" type="file" accept="image/*" class="hidden"
                                onchange="previewImage(this)" />
                            <span id="image-name" class="text-xs text-white/40 hidden"></span>
                        </div>
                        <button id="post-btn" onclick="submitPost()" class="btn-post">Post Update</button>
                    </div>
                    <div id="image-preview-wrap" class="hidden">
                        <img id="image-preview" class="rounded-12 max-h-48 w-full object-cover"
                            style="border-radius:12px" />
                        <button onclick="clearImagePreview()" class="text-xs text-red-400 mt-1 hover:text-red-300">✕
                            Remove image</button>
                    </div>
                </div>
                <div id="admin-wall" class="space-y-4">
                    <div class="text-white/40 text-sm">Loading…</div>
                </div>
            </div>

            <!-- ── REPORTS ── -->
            <div id="section-reports" class="section fade-in">
                <div class="card space-y-5">
                    <h2 class="text-white font-semibold">Attendance Report — CSV Export</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label class="text-white/50 text-xs block mb-1">Select User</label>
                            <select id="rpt-user" class="input" onchange="loadReport()">
                                <option value="all">All Staff</option>
                            </select>
                        </div>
                        <div><label class="text-white/50 text-xs block mb-1">From Date</label><input id="rpt-from"
                                type="date" class="input" onchange="loadReport()" /></div>
                        <div><label class="text-white/50 text-xs block mb-1">To Date</label><input id="rpt-to"
                                type="date" class="input" onchange="loadReport()" /></div>
                    </div>
                    <div class="flex items-center gap-3 flex-wrap">
                        <button onclick="downloadCSV()" class="btn btn-primary flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Download CSV
                        </button>
                        <div id="rpt-msg" class="text-sm text-white/50 hidden"></div>
                    </div>
                    <div class="overflow-x-auto">
                        <table>
                            <thead>
                                <tr>
                                    <th class="text-left font-medium text-white/50 pb-2">Staff</th>
                                    <th class="text-left font-medium text-white/50 pb-2">Date</th>
                                    <th class="text-left font-medium text-white/50 pb-2">Clock In</th>
                                    <th class="text-left font-medium text-white/50 pb-2">Clock Out</th>
                                    <th class="text-left font-medium text-white/50 pb-2">Work Time</th>
                                    <th class="text-left font-medium text-white/50 pb-2">Break Time</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ── SETTINGS ── -->
            <div id="section-settings" class="section fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Basic Info -->
                    <div class="lg:col-span-2 space-y-6">
                        <div class="card">
                            <h3 class="text-white font-semibold mb-6 flex items-center gap-2">
                                <svg class="w-5 h-5 text-violet-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                </svg>
                                Company Identity
                            </h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="col-span-1 sm:col-span-2">
                                    <label
                                        class="text-white/40 text-[10px] mb-1.5 block uppercase tracking-widest font-bold">Company
                                        Name</label>
                                    <input id="set-co-name" type="text" class="input"
                                        placeholder="e.g. Office Hub Global" />
                                </div>
                                <div class="col-span-1 sm:col-span-2">
                                    <label
                                        class="text-white/40 text-[10px] mb-1.5 block uppercase tracking-widest font-bold">Logo
                                        URL</label>
                                    <div class="flex gap-3">
                                        <input id="set-co-logo" type="text" class="input flex-1"
                                            placeholder="https://example.com/logo.png" />
                                        <button onclick="document.getElementById('set-logo-file').click()"
                                            class="btn bg-white/5 hover:bg-white/10 text-white border border-white/10">Upload</button>
                                        <input type="file" id="set-logo-file" class="hidden" accept="image/*"
                                            onchange="uploadCoLogo(this)" />
                                    </div>
                                </div>
                                <div>
                                    <label
                                        class="text-white/40 text-[10px] mb-1.5 block uppercase tracking-widest font-bold">Timezone</label>
                                    <select id="set-co-tz" class="input"></select>
                                </div>
                            </div>
                            <div class="mt-8 flex justify-end">
                                <button id="save-settings-btn" onclick="saveSettings()"
                                    class="btn btn-primary px-8">Save Identity</button>
                            </div>
                        </div>

                        <div class="card">
                            <h3 class="text-white font-semibold mb-6 flex items-center gap-2">
                                <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 5a1 1 0 011-1h4a1 1 0 011 1v5a1 1 0 01-1 1H5a1 1 0 01-1-1V5zm10 0a1 1 0 011-1h4a1 1 0 011 1v2a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zm10-3a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1h-4a1 1 0 01-1-1v-7z" />
                                </svg>
                                Workspace Theme
                            </h3>
                            <div id="theme-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4">
                                <!-- Themes injected by JS -->
                            </div>
                            <div id="settings-msg" class="hidden text-sm rounded-xl px-4 py-3 mt-6"></div>
                        </div>
                    </div>

                    <!-- Preview -->
                    <div class="space-y-6">
                        <div class="card">
                            <h3 class="text-white/50 text-xs font-bold uppercase tracking-widest mb-4">Preview</h3>
                            <div id="preview-box"
                                class="rounded-2xl p-6 aspect-video flex flex-col items-center justify-center text-center gap-3 border border-white/10 relative overflow-hidden">
                                <!-- Preview content -->
                                <div id="preview-logo-box"
                                    class="w-16 h-16 rounded-2xl bg-white/10 flex items-center justify-center overflow-hidden z-10">
                                    <svg class="w-8 h-8 text-white/20" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                    </svg>
                                </div>
                                <div id="preview-co-name" class="text-white font-bold text-lg z-10">Company Name</div>
                                <div id="preview-badge"
                                    class="px-3 py-1 bg-white/20 rounded-full text-[10px] text-white/60 z-10 uppercase tracking-widest">
                                    Workspace Preview</div>
                                <div id="theme-orbs" class="hidden">
                                    <div class="orb orb-1 scale-50" style="background:#6c63ff; top:-50%; left:-50%">
                                    </div>
                                    <div class="orb orb-2 scale-50" style="background:#2dd4bf; bottom:-50%; right:-50%">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ── SUBSCRIPTION (ADMIN) ── -->
            <div id="section-sub" class="section fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Status Card -->
                    <div class="lg:col-span-1 space-y-6">
                        <!-- Staff Quota Card -->
                        <div class="card p-6">
                            <h3 class="text-white font-semibold mb-4 text-sm flex items-center gap-2">
                                <svg class="w-4 h-4 text-violet-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                Staff Quota
                            </h3>
                            <div class="flex justify-between items-end mb-2">
                                <div>
                                    <div class="text-white/40 text-xs mb-0.5">Used</div>
                                    <div id="quota-used" class="text-2xl font-bold text-white">—</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-white/40 text-xs mb-0.5">Limit</div>
                                    <div id="quota-limit" class="text-2xl font-bold text-amber-400">—</div>
                                </div>
                            </div>
                            <div class="w-full bg-white/10 rounded-full h-2 mt-3 overflow-hidden">
                                <div id="quota-bar"
                                    class="h-2 rounded-full transition-all duration-700 bg-gradient-to-r from-violet-500 to-cyan-400"
                                    style="width:0%"></div>
                            </div>
                            <div id="quota-label" class="text-xs text-white/40 mt-2 text-center">Loading…</div>
                        </div>

                        <div id="sub-status-card" class="card p-6 flex flex-col items-center text-center">
                            <div id="sub-days-badge"
                                class="px-4 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest mb-4">...
                            </div>
                            <div class="text-white/40 text-xs mb-1">Subscription Ending On</div>
                            <div id="sub-end-date" class="text-2xl font-bold text-white mb-6">—</div>

                            <div class="w-full pt-6 border-t border-white/5 space-y-3">
                                <div class="flex justify-between text-xs">
                                    <span class="text-white/40">Model</span>
                                    <span id="sub-model-val" class="text-white font-medium capitalize">—</span>
                                </div>
                                <div class="flex justify-between text-xs">
                                    <span class="text-white/40">Amount</span>
                                    <span id="sub-amount-val" class="text-emerald-400 font-bold">$0.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Methods -->
                        <div class="card p-6">
                            <h3 class="text-white font-semibold mb-4 text-sm flex items-center gap-2">
                                <svg class="w-4 h-4 text-amber-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                                </svg>
                                Payment Methods
                            </h3>
                            <div id="co-methods-list" class="space-y-3"></div>
                        </div>
                    </div>

                    <!-- Payment Submission & History -->
                    <div class="lg:col-span-2 space-y-6">
                        <div class="card p-6">
                            <h3 class="text-white font-semibold mb-6 flex items-center justify-between">
                                <span>Submit New Payment</span>
                                <span class="text-[10px] text-white/30 uppercase font-normal tracking-wide">Enter
                                    details
                                    precisely</span>
                            </h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="text-white/40 text-[10px] uppercase font-bold mb-1 block">Amount Paid
                                        ($)</label>
                                    <input type="number" id="pay-amount" class="input" placeholder="0.00" />
                                </div>
                                <div>
                                    <label class="text-white/40 text-[10px] uppercase font-bold mb-1 block">Transaction
                                        ID (Trx ID)</label>
                                    <input type="text" id="pay-trx" class="input"
                                        placeholder="Enter bank/app reference" />
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="text-white/40 text-[10px] uppercase font-bold mb-1 block">Proof of Payment
                                    (Screenshot)</label>
                                <div class="flex gap-3">
                                    <button onclick="document.getElementById('pay-receipt-file').click()"
                                        class="btn flex-1 bg-white/5 border border-white/10 text-xs">Upload
                                        Receipt</button>
                                    <input type="file" id="pay-receipt-file" class="hidden" accept="image/*"
                                        onchange="previewUpload(this, 'receipt-preview', 'pay-receipt-url')" />
                                    <input type="hidden" id="pay-receipt-url" />
                                </div>
                                <img id="receipt-preview"
                                    class="hidden w-20 h-20 object-cover rounded-lg mt-2 border border-white/10" />
                            </div>
                            <div class="mb-6">
                                <label class="text-white/40 text-[10px] uppercase font-bold mb-1 block">Note for Super
                                    Admin (Optional)</label>
                                <textarea id="pay-note" class="input" rows="2"
                                    placeholder="Any additional info…"></textarea>
                            </div>
                            <button id="submit-pay-btn" onclick="submitPayment()"
                                class="btn btn-primary w-full py-3">Submit
                                Payment for Review</button>
                            <div id="pay-msg" class="hidden text-center text-xs mt-3"></div>
                        </div>

                        <!-- History -->
                        <div class="card p-0 overflow-hidden">
                            <div class="px-6 py-4 border-b border-white/5 flex justify-between items-center">
                                <h3 class="text-white font-semibold text-sm">Billing History</h3>
                                <button onclick="exportBilling()" class="text-violet-400 text-xs hover:underline">Export
                                    CSV</button>
                                </table>
                            </div>
                        </div>

                        <!-- Messages to Super Admin -->
                        <div class="card p-6 space-y-4">
                            <h3 class="text-white font-semibold flex items-center gap-2">
                                <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                                </svg>
                                Message Super Admin
                            </h3>
                            <div class="space-y-3">
                                <div>
                                    <label
                                        class="text-white/40 text-[10px] uppercase font-bold mb-1 block">Subject</label>
                                    <input type="text" id="msg-subject" class="input"
                                        placeholder="e.g. Quota increase request, payment inquiry…" />
                                </div>
                                <div>
                                    <label
                                        class="text-white/40 text-[10px] uppercase font-bold mb-1 block">Message</label>
                                    <textarea id="msg-body" class="input" rows="3"
                                        placeholder="Write your message here…"></textarea>
                                </div>
                                <button onclick="sendMessageToSA()" class="btn btn-primary w-full">Send Message</button>
                                <div id="msg-send-result" class="hidden text-xs text-center py-2"></div>
                            </div>
                            <!-- Message History -->
                            <div class="pt-4 border-t border-white/5">
                                <div class="font-semibold text-white text-sm mb-3">My Messages</div>
                                <div id="admin-msg-list" class="space-y-3 max-h-80 overflow-y-auto pr-1">
                                    <div class="text-white/30 text-xs text-center py-4">Loading…</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ── MY PROFILE ── -->
            <div id="section-profile" class="section fade-in">
                <div class="max-w-xl mx-auto space-y-6">
                    <div class="card p-8 flex flex-col items-center text-center">
                        <div class="relative mb-4">
                            <div id="my-profile-avatar"
                                class="w-24 h-24 rounded-2xl bg-gradient-to-br from-violet-500 to-cyan-400 flex items-center justify-center text-white text-3xl font-bold border-4 border-white/5 shadow-2xl overflow-hidden">
                                —
                            </div>
                            <button onclick="openPicActions('my-new-avatar')"
                                class="absolute -bottom-2 -right-2 w-8 h-8 rounded-full bg-violet-600 text-white flex items-center justify-center shadow-lg hover:bg-violet-700 transition-all">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </button>
                        </div>
                        <h2 id="my-profile-name" class="text-xl font-bold text-white mb-1">—</h2>
                        <div class="text-violet-400 text-sm font-medium mb-6 uppercase tracking-widest">
                            Administrator Account</div>

                        <div class="w-full space-y-4 text-left">
                            <div>
                                <label class="text-white/40 text-xs mb-1 block">Full Name</label>
                                <input type="text" id="my-set-name" class="input" placeholder="Update your name">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-white/40 text-xs mb-1 block">Current Password</label>
                                    <input type="password" id="my-old-pass" class="input"
                                        placeholder="Verify old password">
                                </div>
                                <div>
                                    <label class="text-white/40 text-xs mb-1 block">New Password</label>
                                    <input type="password" id="my-new-pass" class="input"
                                        placeholder="Leave blank to keep current">
                                </div>
                            </div>
                            <input type="hidden" id="my-new-avatar">
                            <button id="save-profile-btn" onclick="updateMyProfile()"
                                class="btn btn-primary w-full mt-4 py-3 text-sm">Save Profile Changes</button>
                            <div id="profile-msg"
                                class="hidden text-center text-sm py-2 px-4 rounded-xl bg-violet-500/10 text-violet-300">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <!-- BULK ACTION BAR -->
        <div id="bulk-bar" class="bulk-bar">
            <div class="flex items-center gap-2 text-white font-semibold">
                <span id="bulk-count" class="bg-violet-500 text-white text-xs px-2 py-0.5 rounded-full">0</span>
                <span class="text-sm">Selected</span>
            </div>
            <div class="w-px h-6 bg-white/10"></div>
            <div class="flex items-center gap-3">
                <button id="bulk-delete-btn" onclick="bulkDelete()"
                    class="btn btn-sm btn-danger flex items-center gap-1.5"
                    style="border-radius:1rem; padding: 6px 16px">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Delete Selected
                </button>
                <button id="bulk-manage-btn" onclick="bulkManage()"
                    class="btn btn-sm bg-white/10 text-white flex items-center gap-1.5"
                    style="border-radius:1rem; padding: 6px 16px">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Bulk Manage
                </button>
                <button onclick="clearSelection()" class="text-white/40 hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
    </main>

    <!-- Modal: Top List -->
    <div id="modal-top" class="modal-bg">
        <div class="modal fade-in max-w-lg w-full">
            <h2 id="modal-top-title" class="text-xl font-bold text-white mb-5">Leaderboard</h2>
            <div id="modal-top-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                <!-- List goes here -->
            </div>
            <div class="mt-6 flex gap-3">
                <button onclick="closeModal('modal-top')" class="btn w-full"
                    style="background:rgba(255,255,255,0.05);color:#fff">Close</button>
            </div>
        </div>
    </div>

    <!-- Modal: Report Details -->
    <div id="modal-report-details" class="modal-bg">
        <div class="modal fade-in max-w-lg w-full">
            <h2 id="modal-report-title" class="text-xl font-bold text-white mb-5">Daily Logs</h2>
            <div id="modal-report-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                <!-- Detailed logs go here -->
            </div>
            <div class="mt-6 flex gap-3">
                <button onclick="closeModal('modal-report-details')" class="btn w-full"
                    style="background:rgba(255,255,255,0.05);color:#fff">Close</button>
            </div>
        </div>
    </div>

    <!-- Modal: Add Staff -->
    <div id="modal-add" class="modal-bg">
        <div class="modal">
            <h3 class="text-white font-semibold text-lg mb-5">Add New Staff</h3>
            <div class="space-y-3">
                <input id="new-name" type="text" class="input" placeholder="Full name" />
                <input id="new-username" type="text" class="input" placeholder="Username" />
                <input id="new-pass" type="password" class="input" placeholder="Password" />
                <select id="new-role" class="input">
                    <option value="staff">Staff</option>
                    <option value="admin">Admin</option>
                </select>
                <div class="p-3 bg-white/5 rounded-xl border border-white/10 space-y-3">
                    <label class="text-white/40 text-xs block">Profile Picture</label>
                    <div class="flex items-center gap-3">
                        <img id="new-avatar-preview" src="" class="hidden img-preview-mod" />
                        <div class="flex-1 flex gap-2">
                            <button onclick="document.getElementById('new-avatar-file').click()"
                                class="btn btn-sm bg-white/10 flex-1">Upload</button>
                            <button onclick="openCamera('new-avatar')"
                                class="btn btn-sm bg-white/10 flex-1">Camera</button>
                        </div>
                    </div>
                    <input type="file" id="new-avatar-file" class="hidden" accept="image/*"
                        onchange="previewUpload(this, 'new-avatar-preview', 'new-avatar')" />
                    <input type="hidden" id="new-avatar" />
                </div>
                <div id="add-err" class="hidden text-red-400 text-sm"></div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="createUser()" class="btn btn-primary flex-1">Create User</button>
                <button onclick="closeModal('modal-add')" class="btn flex-1"
                    style="background:rgba(255,255,255,0.07);color:#94a3b8">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal: Edit Staff -->
    <div id="modal-edit" class="modal-bg">
        <div class="modal" style="max-width:500px">
            <div class="flex items-center justify-between mb-5">
                <h3 class="text-white font-semibold text-lg">Edit Staff Member</h3>
                <button onclick="closeModal('modal-edit')" class="text-white/40 hover:text-white">✕</button>
            </div>
            <input type="hidden" id="edit-id" />
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2">
                    <label class="text-white/40 text-xs mb-1 block">Full Name</label>
                    <input id="edit-name" type="text" class="input" placeholder="Full name" />
                </div>
                <div>
                    <label class="text-white/40 text-xs mb-1 block">Username</label>
                    <input id="edit-username" type="text" class="input" placeholder="Username" />
                </div>
                <div>
                    <label class="text-white/40 text-xs mb-1 block">Password</label>
                    <input id="edit-pass" type="text" class="input" placeholder="Password" />
                </div>
                <div>
                    <label class="text-white/40 text-xs mb-1 block">Role</label>
                    <select id="edit-role" class="input">
                        <option value="staff">Staff</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div>
                    <label class="text-white/40 text-xs mb-1 block">Status</label>
                    <select id="edit-suspended" class="input">
                        <option value="false">Active</option>
                        <option value="true">Suspended / Paused</option>
                    </select>
                </div>
                <div>
                    <label class="text-white/40 text-xs mb-1 block">Salary</label>
                    <input id="edit-salary" type="text" class="input" placeholder="e.g. $5000/mo" />
                </div>
                <div>
                    <label class="text-white/40 text-xs mb-1 block">Duty Time</label>
                    <input id="edit-duty" type="text" class="input" placeholder="e.g. 9AM - 5PM" />
                </div>
                <div class="col-span-2">
                    <label class="text-white/40 text-xs mb-1 block">Profile Picture</label>
                    <div class="flex items-center gap-4 p-3 bg-white/5 rounded-xl border border-white/10">
                        <img id="edit-avatar-preview" src="" class="hidden img-preview-mod" />
                        <div class="flex-1 flex gap-2">
                            <button onclick="document.getElementById('edit-avatar-file').click()"
                                class="btn btn-sm bg-white/10 flex-1">Upload</button>
                            <button onclick="openCamera('edit-avatar')" class="btn btn-sm bg-white/10 flex-1">Take
                                Photo</button>
                        </div>
                        <input type="file" id="edit-avatar-file" class="hidden" accept="image/*"
                            onchange="previewUpload(this, 'edit-avatar-preview', 'edit-avatar')" />
                        <input type="hidden" id="edit-avatar" />
                    </div>
                </div>
                <div class="col-span-2">
                    <label class="text-white/40 text-xs mb-1 block">Custom Note</label>
                    <textarea id="edit-note" class="input" placeholder="Internal notes…"></textarea>
                </div>
            </div>
            <div id="edit-err" class="hidden text-red-400 text-sm mt-3"></div>
            <div class="flex gap-3 mt-6">
                <button onclick="updateUser()" class="btn btn-primary flex-1">Save Changes</button>
                <button onclick="closeModal('modal-edit')" class="btn flex-1"
                    style="background:rgba(255,255,255,0.07);color:#94a3b8">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal: Seen By -->
    <div id="modal-seen" class="modal-bg">
        <div class="modal" style="max-width:500px">
            <div class="flex items-center justify-between mb-5">
                <h3 class="text-white font-semibold">Seen By</h3>
                <button onclick="closeModal('modal-seen')" class="text-white/40 hover:text-white">✕</button>
            </div>
            <div id="seen-list" class="space-y-2 max-h-72 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Modal: Edit Notification -->
    <div id="modal-edit-notif" class="modal-bg">
        <div class="modal" style="max-width:500px">
            <div class="flex items-center justify-between mb-5">
                <h3 class="text-white font-semibold">Edit Notification</h3>
                <button onclick="closeModal('modal-edit-notif')" class="text-white/40 hover:text-white">✕</button>
            </div>
            <input type="hidden" id="edit-notif-id" />
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-white/40 text-xs mb-1 block">Recipient</label>
                        <select id="edit-notif-target" class="input"></select>
                    </div>
                    <div>
                        <label class="text-white/40 text-xs mb-1 block">Title</label>
                        <input id="edit-notif-title" type="text" class="input" />
                    </div>
                </div>
                <div>
                    <label class="text-white/40 text-xs mb-1 block">Body</label>
                    <textarea id="edit-notif-body" class="input" rows="3"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-white/40 text-xs mb-1 block">Attachment Type</label>
                        <select id="edit-notif-att-type" class="input">
                            <option value="">No Attachment</option>
                            <option value="image">Image URL</option>
                            <option value="link">Web Link</option>
                            <option value="file">File URL</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-white/40 text-xs mb-1 block">Attachment URL</label>
                        <input id="edit-notif-att-url" type="text" class="input" />
                    </div>
                </div>
                <div class="flex gap-3 pt-2">
                    <button onclick="updateNotif()" class="btn btn-primary flex-1">Save Changes</button>
                    <button onclick="closeModal('modal-edit-notif')"
                        class="btn flex-1 bg-white/5 text-white/40">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Camera -->
    <div id="modal-camera" class="modal-bg">
        <div class="modal" style="max-width:400px">
            <h3 class="text-white font-semibold mb-4">Take Photo</h3>
            <div class="camera-view mb-4">
                <video id="camera-video" autoplay playsinline></video>
                <canvas id="camera-canvas" class="hidden"></canvas>
            </div>
            <div class="flex gap-3">
                <button onclick="capturePhoto()" class="btn btn-primary flex-1">Capture</button>
                <button onclick="closeCamera()" class="btn flex-1 bg-white/5 text-white/40">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal: Photo Actions -->
    <div id="modal-pic-actions" class="modal-bg">
        <div class="modal" style="max-width:320px">
            <h3 class="text-white font-semibold mb-5 text-center">Change Photo</h3>
            <div class="flex flex-col gap-3">
                <button onclick="document.getElementById('profile-file-input').click()" class="clock-btn btn-in">Upload
                    Image</button>
                <button onclick="closeModal('modal-pic-actions'); openCamera(activeCamInput)"
                    class="clock-btn btn-brk">Take Photo</button>
                <button onclick="closeModal('modal-pic-actions')" class="clock-btn btn-out">Cancel</button>
            </div>
            <input type="file" id="profile-file-input" class="hidden" accept="image/*"
                onchange="previewProfileUpload(this)">
        </div>
    </div>

    <!-- Modal: Full View Image -->
    <div id="modal-full-view" class="modal-bg" onclick="closeModal('modal-full-view')">
        <div class="flex flex-col items-center justify-center min-h-screen p-4">
            <img id="full-view-img" src=""
                class="max-w-full max-h-[90vh] rounded-xl shadow-2xl border border-white/10" />
            <p class="text-white/40 text-xs mt-4">Click anywhere to close</p>
        </div>
    </div>

    <script src="supabase-config.js"></script>
    <script>
        let myUser = null, myProfile = null, myStaff = [], attendRtSub = null;
        let activeCamInput = null, stream = null;

        async function openCamera(inputId) {
            activeCamInput = inputId;
            openModal('modal-camera');
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                document.getElementById('camera-video').srcObject = stream;
            } catch (err) {
                alert('Camera access denied or not found');
                closeModal('modal-camera');
            }
        }

        function openPicActions(inputId) {
            activeCamInput = inputId;
            openModal('modal-pic-actions');
        }

        async function previewProfileUpload(input) {
            const file = input.files[0];
            if (!file || !activeCamInput) return;
            closeModal('modal-pic-actions');

            const cleanName = file.name.replace(/[^a-z0-9.]/gi, '_').toLowerCase();
            const path = `${myProfile.company_id}/${Date.now()}_${cleanName}`;

            const { error } = await sb.storage.from('avatars').upload(path, file, { upsert: true });
            if (error) {
                console.error('Upload Error:', error);
                return alert('Avatar upload failed: ' + (error.message || 'Check storage buckets'));
            }

            const { data: pub } = sb.storage.from('avatars').getPublicUrl(path);
            document.getElementById(activeCamInput).value = pub.publicUrl;

            if (activeCamInput === 'my-new-avatar') {
                const av = document.getElementById('my-profile-avatar');
                av.innerHTML = `<img src="${pub.publicUrl}" class="w-full h-full object-cover">`;
                const sbAv = document.getElementById('sb-avatar');
                if (sbAv) sbAv.innerHTML = `<img src="${pub.publicUrl}" class="w-full h-full rounded-full object-cover">`;
            } else {
                const previewId = activeCamInput === 'new-avatar' ? 'new-avatar-preview' : 'edit-avatar-preview';
                const prev = document.getElementById(previewId);
                if (prev) { prev.src = pub.publicUrl; prev.classList.remove('hidden'); }
            }
        }

        function closeCamera() {
            if (stream) stream.getTracks().forEach(t => t.stop());
            closeModal('modal-camera');
        }

        async function capturePhoto() {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.8));
            const fileName = `cam_${Date.now()}.jpg`;
            const path = `${myProfile.company_id}/${fileName}`;

            const { error } = await sb.storage.from('avatars').upload(path, blob, { contentType: 'image/jpeg', upsert: true });
            if (error) {
                console.error('Camera Upload Error:', error);
                return alert('Camera upload failed: ' + (error.message || 'Check if buckets are created in Supabase'));
            }

            const { data: pub } = sb.storage.from('avatars').getPublicUrl(path);
            document.getElementById(activeCamInput).value = pub.publicUrl;

            const previewId = activeCamInput === 'new-avatar' ? 'new-avatar-preview' : 'edit-avatar-preview';
            const prev = document.getElementById(previewId);
            if (prev) { prev.src = pub.publicUrl; prev.classList.remove('hidden'); }

            closeCamera();
        }

        async function previewUpload(input, previewId, hiddenId) {
            const file = input.files[0];
            if (!file) return;
            // Sanitize filename: remove spaces and non-alphanumeric chars keep extension
            const cleanName = file.name.replace(/[^a-z0-9.]/gi, '_').toLowerCase();
            const path = `${myProfile.company_id}/${Date.now()}_${cleanName}`;

            const { error } = await sb.storage.from('avatars').upload(path, file, { upsert: true });
            if (error) {
                console.error('Upload Error:', error);
                return alert('Avatar upload failed: ' + (error.message || 'Check storage buckets'));
            }

            const { data: pub } = sb.storage.from('avatars').getPublicUrl(path);
            const hid = document.getElementById(hiddenId);
            if (hid) hid.value = pub.publicUrl;

            const prev = document.getElementById(previewId);
            if (prev) { prev.src = pub.publicUrl; prev.classList.remove('hidden'); }
        }

        async function uploadNotifFile(input) {
            const file = input.files[0];
            if (!file) return;
            const cleanName = file.name.replace(/[^a-z0-9.]/gi, '_').toLowerCase();
            const path = `${myProfile.company_id}/${Date.now()}_${cleanName}`;

            const { error } = await sb.storage.from('notif-attachments').upload(path, file, { upsert: true });
            if (error) {
                console.error('Notif File Error:', error);
                return alert('File upload failed: ' + (error.message || 'Check storage config'));
            }

            const { data: pub } = sb.storage.from('notif-attachments').getPublicUrl(path);
            document.getElementById('notif-att-url').value = pub.publicUrl;

            // Auto-set type based on extension
            const ext = file.name.split('.').pop().toLowerCase();
            const typeSel = document.getElementById('notif-att-type');
            if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) typeSel.value = 'image';
            else typeSel.value = 'file';
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('overlay').classList.toggle('show') }
        function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('overlay').classList.remove('show') }
        function openModal(id) { document.getElementById(id).classList.add('show') }
        function closeModal(id) { document.getElementById(id).classList.remove('show') }

        const titles = { dash: 'Dashboard', staff: 'Staff Management', attend: 'Attendance Monitor', notifs: 'Notifications', wall: 'Social Wall', reports: 'Reports & CSV', sub: 'Subscription & Billing', settings: 'Company Settings', profile: 'My Profile', msg: 'Messages' };
        let isCompanyLocked = false;

        function show(name) {
            if (isCompanyLocked && name !== 'sub') {
                alert('Access restricted. Please complete your subscription payment.');
                show('sub');
                return;
            }
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const sec = document.getElementById('section-' + name);
            if (sec) sec.classList.add('active');
            const nav = document.getElementById('nav-' + name);
            if (nav) nav.classList.add('active');
            document.getElementById('page-title').textContent = titles[name] || name;
            closeSidebar();
            if (name === 'attend') loadAttendance();
            if (name === 'notifs') loadNotifs();
            if (name === 'wall') loadWall();
            if (name === 'reports') loadReport();
            if (name === 'sub') loadSubInfo();
            if (name === 'settings') loadSettings();
            if (name === 'profile') loadMyProfile();
        }

        /* Subscription Logic (Admin) */
        async function loadSubInfo() {
            const { data: co } = await sb.from('companies').select('*').eq('id', myProfile.company_id).single();
            if (!co) return;
            myCompany = co;

            const end = co.subscription_end_date ? new Date(co.subscription_end_date) : null;
            const now = new Date();
            const daysLeft = end ? Math.ceil((end - now) / (1000 * 60 * 60 * 24)) : 0;
            const graceDays = co.grace_period_days || 3;

            // Update UI
            document.getElementById('sub-end-date').textContent = end ? end.toLocaleDateString() : 'No Active Contract';
            document.getElementById('sub-model-val').textContent = co.subscription_model || 'monthly';
            document.getElementById('sub-amount-val').textContent = `$${co.subscription_amount || '0.00'}`;

            const badge = document.getElementById('sub-days-badge');
            if (daysLeft < 0) {
                badge.textContent = `Overdue by ${Math.abs(daysLeft)} Days`;
                badge.className = 'px-4 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest mb-4 bg-red-500/20 text-red-500';
            } else {
                badge.textContent = `${daysLeft} Days Remaining`;
                badge.className = `px-4 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest mb-4 ${daysLeft < 7 ? 'bg-amber-500/20 text-amber-500' : 'bg-emerald-500/20 text-emerald-500'}`;
            }

            // Lock Logic
            if (daysLeft < -graceDays) {
                isCompanyLocked = true;
            } else {
                isCompanyLocked = false;
            }

            // Staff Quota Display
            await loadStaffQuota(co);

            loadCoPaymentMethods();
            loadPaymentHistory();
            loadAdminMessages();
        }

        async function loadStaffQuota(co) {
            const { data: staffData } = await sb.from('profiles').select('id').eq('company_id', myProfile.company_id);
            const used = staffData?.length || 0;
            const limit = co.staff_limit;

            document.getElementById('quota-used').textContent = used;

            if (!limit || limit === 0) {
                document.getElementById('quota-limit').textContent = '∞';
                document.getElementById('quota-bar').style.width = '30%';
                document.getElementById('quota-bar').style.background = 'linear-gradient(90deg, #6c63ff, #2dd4bf)';
                document.getElementById('quota-label').textContent = `${used} used — No limit set`;
            } else {
                const pct = Math.min((used / limit) * 100, 100);
                const remaining = limit - used;
                document.getElementById('quota-limit').textContent = limit;
                document.getElementById('quota-bar').style.width = pct + '%';
                if (pct >= 100) {
                    document.getElementById('quota-bar').style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
                    document.getElementById('quota-label').textContent = `⚠ Quota full — Contact Super Admin to increase limit`;
                    document.getElementById('quota-label').style.color = '#f87171';
                } else if (pct >= 80) {
                    document.getElementById('quota-bar').style.background = 'linear-gradient(90deg, #f59e0b, #d97706)';
                    document.getElementById('quota-label').textContent = `${remaining} slot${remaining !== 1 ? 's' : ''} remaining of ${limit}`;
                } else {
                    document.getElementById('quota-bar').style.background = 'linear-gradient(90deg, #6c63ff, #2dd4bf)';
                    document.getElementById('quota-label').textContent = `${remaining} slot${remaining !== 1 ? 's' : ''} remaining of ${limit}`;
                }
            }
        }

        /* Admin → Super Admin Messaging */
        async function sendMessageToSA() {
            const subject = document.getElementById('msg-subject').value.trim();
            const body = document.getElementById('msg-body').value.trim();
            const result = document.getElementById('msg-send-result');
            if (!subject || !body) { result.textContent = '⚠ Subject and message are required.'; result.className = 'text-xs text-center py-2 text-amber-400'; result.classList.remove('hidden'); return; }

            const { error } = await sb.from('company_messages').insert({
                company_id: myProfile.company_id,
                admin_id: myUser.id,
                subject,
                body
            });

            if (error) {
                result.textContent = '❌ Failed to send: ' + error.message;
                result.className = 'text-xs text-center py-2 text-red-400';
            } else {
                result.textContent = '✅ Message sent to Super Admin!';
                result.className = 'text-xs text-center py-2 text-emerald-400';
                document.getElementById('msg-subject').value = '';
                document.getElementById('msg-body').value = '';
                loadAdminMessages();
            }
            result.classList.remove('hidden');
            setTimeout(() => result.classList.add('hidden'), 4000);
        }

        async function loadAdminMessages() {
            const { data } = await sb.from('company_messages')
                .select('*')
                .eq('company_id', myProfile.company_id)
                .order('created_at', { ascending: false });

            const list = document.getElementById('admin-msg-list');
            if (!data?.length) {
                list.innerHTML = '<div class="text-white/25 text-xs text-center py-4">No messages sent yet.</div>';
                return;
            }
            list.innerHTML = data.map(m => {
                const statusDot = m.reply
                    ? '<span class="inline-flex items-center gap-1 text-[9px] text-emerald-400 bg-emerald-500/10 px-2 py-0.5 rounded-full font-bold">✓ Replied</span>'
                    : '<span class="inline-flex items-center gap-1 text-[9px] text-amber-400 bg-amber-500/10 px-2 py-0.5 rounded-full font-bold">⏳ Pending</span>';
                return `
                <div class="bg-white/5 border border-white/10 rounded-xl p-4 space-y-2">
                    <div class="flex items-start justify-between gap-2">
                        <div class="font-semibold text-white text-xs">${esc(m.subject)}</div>
                        ${statusDot}
                    </div>
                    <div class="text-white/50 text-xs">${esc(m.body)}</div>
                    ${m.reply ? `
                    <div class="mt-2 ml-2 pl-3 border-l-2 border-amber-500/40">
                        <div class="text-[10px] text-amber-400 font-bold mb-0.5">Super Admin Reply:</div>
                        <div class="text-white/60 text-xs">${esc(m.reply)}</div>
                        <div class="text-[9px] text-white/25 mt-1">${new Date(m.replied_at).toLocaleString()}</div>
                    </div>` : ''}
                    <div class="text-[9px] text-white/25">${new Date(m.created_at).toLocaleString()}</div>
                </div>`;
            }).join('');
        }

        async function loadCoPaymentMethods() {
            const { data } = await sb.from('payment_methods').select('*').eq('is_active', true);
            const list = document.getElementById('co-methods-list');
            list.innerHTML = (data || []).map(m => `
                <div class="p-3 bg-white/5 rounded-xl border border-white/10 relative">
                    <div class="flex items-start justify-between mb-2 gap-2">
                        <span class="text-xs font-bold text-amber-400 break-words flex-1 mt-0.5">${esc(m.name)}</span>
                        ${m.qr_url ? `<button onclick="openFullView('${m.qr_url}')" class="text-[9px] text-violet-400 underline whitespace-nowrap bg-violet-400/10 px-2 py-1 rounded hover:bg-violet-400/20 transition-colors">View QR</button>` : ''}
                    </div>
                    <div class="flex items-start gap-2 bg-black/20 p-2 rounded-lg border border-white/5">
                        <div class="text-[11px] text-white/70 font-mono select-all flex-1 break-all leading-relaxed">${esc(m.account_info || '')}</div>
                        <button onclick="navigator.clipboard.writeText('${esc(m.account_info)}').then(()=>alert('Copied to clipboard!'))" class="p-1.5 rounded-md bg-white/10 hover:bg-white/20 text-white/50 hover:text-white transition-colors flex-shrink-0" title="Copy to clipboard">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                        </button>
                    </div>
                    ${m.note ? `<div class="text-[9px] text-white/30 mt-2 italic break-words">${esc(m.note)}</div>` : ''}
                </div>
            `).join('');
            if (!data?.length) list.innerHTML = '<div class="text-white/20 text-[10px] text-center py-4">Contact Super Admin for payment details.</div>';
        }

        async function submitPayment() {
            const btn = document.getElementById('submit-pay-btn');
            const msg = document.getElementById('pay-msg');
            const amount = document.getElementById('pay-amount').value;
            const trx = document.getElementById('pay-trx').value.trim();
            const receipt = document.getElementById('pay-receipt-url').value;
            const note = document.getElementById('pay-note').value.trim();

            if (!amount || !trx) return alert('Amount and Transaction ID are required.');

            btn.disabled = true;
            btn.textContent = 'Submitting…';

            const { error } = await sb.from('payment_submissions').insert({
                company_id: myProfile.company_id,
                admin_id: myUser.id,
                amount: parseFloat(amount),
                trx_id: trx,
                receipt_url: receipt,
                note: note
            });

            if (error) {
                msg.textContent = '❌ Submission failed: ' + error.message;
                msg.className = 'text-center text-xs mt-3 text-red-400';
            } else {
                msg.textContent = '✅ Payment submitted successfully! Waiting for approval.';
                msg.className = 'text-center text-xs mt-3 text-emerald-400';
                // Reset form
                document.getElementById('pay-amount').value = '';
                document.getElementById('pay-trx').value = '';
                document.getElementById('pay-receipt-url').value = '';
                document.getElementById('receipt-preview').classList.add('hidden');
                document.getElementById('pay-note').value = '';
                loadPaymentHistory();
            }
            msg.classList.remove('hidden');
            btn.disabled = false;
            btn.textContent = 'Submit New Payment';
        }

        async function loadPaymentHistory() {
            const { data } = await sb.from('payment_submissions').select('*').eq('company_id', myProfile.company_id).order('created_at', { ascending: false });
            const body = document.getElementById('pay-history-body');
            body.innerHTML = (data || []).map(p => {
                const statusCls = p.status === 'approved' ? 'text-emerald-400' : p.status === 'rejected' ? 'text-red-400' : 'text-amber-400';
                return `
                    <tr class="border-b border-white/5">
                        <td class="px-6 py-4 text-white/50">${new Date(p.created_at).toLocaleString()}</td>
                        <td class="px-6 py-4 font-bold">$${p.amount}</td>
                        <td class="px-6 py-4 uppercase font-bold tracking-tighter ${statusCls}">${p.status}</td>
                        <td class="px-6 py-4">
                            <div class="text-white/60 max-w-[150px] truncate" title="${esc(p.note || p.remark || '')}">${esc(p.note || p.remark || '—')}</div>
                        </td>
                    </tr>
                `;
            }).join('');
            if (!data?.length) body.innerHTML = '<tr><td colspan="4" class="text-center text-white/20 py-8">No payment history found.</td></tr>';
        }

        function exportBilling() {
            // Placeholder for CSV export - reusing download logic similar to reports
            alert('Exporting billing history…');
        }

        function esc(s) { if (!s) return ''; return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') }
        function timeAgo(t) { const s = Math.floor((Date.now() - new Date(t)) / 1000); if (s < 60) return 'just now'; if (s < 3600) return Math.floor(s / 60) + 'm ago'; if (s < 86400) return Math.floor(s / 3600) + 'h ago'; return Math.floor(s / 86400) + 'd ago' }
        function initials(n) { if (!n) return '?'; return n.split(' ').map(p => p[0]).join('').toUpperCase().slice(0, 2) }

        // ── STAFF ──
        async function loadStaff() {
            const { data } = await sb.from('profiles')
                .select('*')
                .eq('company_id', myProfile.company_id)
                .order('created_at', { ascending: false });
            myStaff = data || [];
            const body = document.getElementById('staff-body');
            if (!myStaff.length) { body.innerHTML = '<tr><td colspan="7" class="text-center text-white/40 py-4">No staff yet.</td></tr>'; return }
            body.innerHTML = myStaff.map(u => `<tr class="staff-row" onclick="openStaffDetail('${u.id}')">
    <td onclick="event.stopPropagation()"><input type="checkbox" class="bulk-item-check staff-checkbox" value="${u.id}" onclick="updateBulkBar()"></td>
    <td>
        <div class="flex items-center gap-2">
            <div class="avatar">${u.avatar_url ? `<img src="${u.avatar_url}" class="w-full h-full rounded-full object-cover">` : initials(u.full_name || u.username)}</div>
            <div>
                <span class="text-white font-medium text-sm">${esc(u.full_name || '—')}</span>
                ${(String(u.is_suspended) === 'true') ? `<span class="text-[10px] text-red-400 block font-bold">SUSPENDED</span>` : ''}
            </div>
        </div>
    </td>
    <td class="text-white/60 text-xs">${esc(u.username || '—')}</td>
    <td><span class="badge ${u.role === 'admin' ? 'badge-admin' : 'badge-staff'}">${u.role}</span></td>
    <td class="text-white/50 text-xs">${esc(u.salary || '—')}</td>
    <td class="text-white/50 text-xs">${esc(u.duty_time || '—')}</td>
    <td class="text-white/50 text-xs">${new Date(u.created_at).toLocaleDateString()}</td>
    <td>
        <div class="flex gap-2">
            <button onclick="event.stopPropagation();openEditStaff('${u.id}')" class="btn btn-sm" style="background:rgba(108,99,255,0.15);color:#a5b4fc">Edit</button>
            <button onclick="event.stopPropagation();deleteUser('${u.id}')" class="btn btn-danger btn-sm">Remove</button>
        </div>
    </td>
  </tr>`).join('');
            updateStats();

            // Populate edit-notif-target and report selects (normal <select>)
            const editNotifSel = document.getElementById('edit-notif-target');
            if (editNotifSel) {
                const cur = editNotifSel.value;
                editNotifSel.innerHTML = `<option value="all">Company Wide (All Staff)</option>`;
                myStaff.forEach(s => { editNotifSel.innerHTML += `<option value="${s.id}">${esc(s.full_name || s.username)}</option>`; });
                editNotifSel.value = cur;
            }
            const rptSel = document.getElementById('rpt-user');
            if (rptSel) {
                const cur2 = rptSel.value;
                rptSel.innerHTML = `<option value="all">All Staff</option>`;
                myStaff.forEach(s => { rptSel.innerHTML += `<option value="${s.id}">${esc(s.full_name || s.username)}</option>`; });
                rptSel.value = cur2;
            }
            // Rebuild multi-select staff picker for notifications
            buildStaffPicker('notif', myStaff);
        }

        async function updateStats() {
            const activeStaff = myStaff.filter(u => u.role === 'staff' && String(u.is_suspended) !== 'true');
            document.getElementById('stat-staff').textContent = activeStaff.length;

            const today = new Date().toISOString().slice(0, 10);

            // Parallelise attendance + posts queries
            const [{ data: att }, { data: posts }] = await Promise.all([
                sb.from('attendance')
                    .select('user_id, status')
                    .eq('company_id', myProfile.company_id)
                    .order('created_at', { ascending: false }),
                sb.from('posts')
                    .select('id', { count: 'exact', head: true })
                    .eq('company_id', myProfile.company_id)
                    .gte('created_at', today + 'T00:00:00')
            ]);

            const latest = {};
            (att || []).forEach(r => { if (!latest[r.user_id]) latest[r.user_id] = r.status });

            let inCount = 0, breakCount = 0;
            myStaff.forEach(u => {
                if (String(u.is_suspended) === 'true') return;
                if (latest[u.id] === 'in' || latest[u.id] === 'break_in') inCount++;
                if (latest[u.id] === 'break') breakCount++;
            });

            document.getElementById('stat-in').textContent = inCount;
            document.getElementById('stat-break').textContent = breakCount;
            document.getElementById('stat-posts').textContent = posts?.length ?? 0;
        }

        function openAddStaff() { openModal('modal-add') }

        async function createUser() {
            const name = document.getElementById('new-name').value.trim();
            const username = document.getElementById('new-username').value.trim();
            const pass = document.getElementById('new-pass').value;
            const role = document.getElementById('new-role').value;
            const errEl = document.getElementById('add-err');
            errEl.classList.add('hidden');
            if (!username || !pass) { errEl.textContent = 'Username and password required.'; errEl.classList.remove('hidden'); return }

            // ── Staff Limit Check ──
            const { data: coData } = await sb.from('companies').select('staff_limit').eq('id', myProfile.company_id).single();
            const staffLimit = coData?.staff_limit;
            if (staffLimit && staffLimit > 0) {
                const { data: existingStaff } = await sb.from('profiles').select('id').eq('company_id', myProfile.company_id);
                const currentCount = existingStaff?.length || 0;
                if (currentCount >= staffLimit) {
                    errEl.textContent = `Staff limit reached (${currentCount}/${staffLimit}). Contact your Super Admin to increase the limit.`;
                    errEl.classList.remove('hidden');
                    return;
                }
            }

            const { data, error } = await sb.from('profiles').insert({
                full_name: name,
                username: username,
                password: pass,
                role: role,
                company_id: myProfile.company_id,
                avatar_url: document.getElementById('new-avatar').value
            }).select();

            if (error) {
                errEl.textContent = error.message;
                errEl.classList.remove('hidden');
                return;
            }

            closeModal('modal-add');
            // Clear inputs & previews
            ['new-name', 'new-username', 'new-pass', 'new-avatar'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('new-avatar-preview').classList.add('hidden');
            await loadStaff();
        }

        async function deleteUser(id) {
            if (!confirm('Remove this user?')) return;
            await sb.from('profiles').delete().eq('id', id);
            await loadStaff();
        }

        async function openEditStaff(id) {
            // Fetch LATEST data from Supabase
            const { data: u, error } = await sb.from('profiles').select('*').eq('id', id).single();
            if (error || !u) {
                alert('Error fetching user data: ' + error?.message);
                return;
            }

            document.getElementById('edit-id').value = u.id;
            document.getElementById('edit-name').value = u.full_name || '';
            document.getElementById('edit-username').value = u.username || '';
            document.getElementById('edit-pass').value = u.password || '';
            document.getElementById('edit-role').value = u.role;
            document.getElementById('edit-suspended').value = (String(u.is_suspended) === 'true') ? 'true' : 'false';
            document.getElementById('edit-salary').value = u.salary || '';
            document.getElementById('edit-duty').value = u.duty_time || '';
            document.getElementById('edit-avatar').value = u.avatar_url || '';
            document.getElementById('edit-note').value = u.custom_note || '';

            const prev = document.getElementById('edit-avatar-preview');
            if (u.avatar_url) { prev.src = u.avatar_url; prev.classList.remove('hidden'); }
            else { prev.src = ''; prev.classList.add('hidden'); }

            openModal('modal-edit');
        }

        async function updateUser() {
            const id = document.getElementById('edit-id').value;
            const data = {
                full_name: document.getElementById('edit-name').value.trim(),
                username: document.getElementById('edit-username').value.trim(),
                password: document.getElementById('edit-pass').value,
                role: document.getElementById('edit-role').value,
                is_suspended: document.getElementById('edit-suspended').value === 'true',
                salary: document.getElementById('edit-salary').value.trim(),
                duty_time: document.getElementById('edit-duty').value.trim(),
                avatar_url: document.getElementById('edit-avatar').value.trim(),
                custom_note: document.getElementById('edit-note').value.trim()
            };
            const errEl = document.getElementById('edit-err');
            errEl.classList.add('hidden');

            const { error } = await sb.from('profiles').update(data).eq('id', id);
            if (error) {
                errEl.textContent = error.message;
                errEl.classList.remove('hidden');
                return;
            }
            closeModal('modal-edit');
            await loadStaff(); // Refresh first
            alert('Staff member updated successfully!');
        }

        // ── ATTENDANCE MONITOR ──
        let allRankings = []; // Global for leaderboard
        let currentAttendRows = []; // Global for Live Monitor Export
        let currentAttendStats = {}; // Global for Live Monitor Export

        function exportStaffCSV() {
            if (!myStaff || !myStaff.length) return alert('No staff data to export.');
            const headers = ['Name', 'Username', 'Role', 'Status', 'Joined Date'];
            const rows = myStaff.map(u => [
                (u.full_name || '—').replace(/,/g, ''),
                (u.username || '—').replace(/,/g, ''),
                u.role || '—',
                (String(u.is_suspended) === 'true') ? 'Suspended' : 'Active',
                new Date(u.created_at).toLocaleDateString()
            ]);

            const csvContent = "data:text/csv;charset=utf-8," + [headers, ...rows].map(e => e.join(",")).join("\n");
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `staff_list_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            link.remove();
        }

        function exportAttendCSV() {
            if (!currentAttendRows || !currentAttendRows.length) return alert('No attendance data available to export.');

            const headers = ['Staff Member', 'Status', 'In Time', 'Out Time', 'Work Today', 'Break Today', 'IP Address', 'Location'];
            const statusMeta = { in: 'Clocked In', break_in: 'Clocked In', break: 'On Break', out: 'Out' };
            const fmt = ms => {
                const h = Math.floor(ms / 3600000);
                const m = Math.floor((ms % 3600000) / 60000);
                return `${h}h ${m}m`;
            };

            const csvRows = currentAttendRows.map(r => {
                const m = statusMeta[r.status] || 'Out';
                const loc = r.latitude ? `${parseFloat(r.latitude).toFixed(3)},${parseFloat(r.longitude).toFixed(3)}` : '—';
                const s = currentAttendStats[r.user_id] || { work: 0, break: 0, inTime: '—', outTime: '—' };

                return [
                    (r.profiles?.full_name || '—').replace(/,/g, ''),
                    m,
                    s.inTime,
                    s.outTime,
                    fmt(s.work),
                    fmt(s.break),
                    r.ip_address || '—',
                    `"${loc}"`
                ];
            });

            const csvContent = "data:text/csv;charset=utf-8," + [headers, ...csvRows].map(e => e.join(",")).join("\n");
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `live_attendance_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            link.remove();
        }

        function openTopModal(type) {
            const titleEl = document.getElementById('modal-top-title');
            const listEl = document.getElementById('modal-top-list');
            let sorted = [];
            let typeClass = '';
            let valKey = '';

            if (type === 'work') {
                titleEl.textContent = 'Leaderboard: Most Work Time';
                sorted = [...allRankings].filter(u => u.work > 0).sort((a, b) => b.work - a.work);
                typeClass = 'emerald-400'; valKey = 'work';
            } else if (type === 'break-most') {
                titleEl.textContent = 'Leaderboard: Most Break Time';
                sorted = [...allRankings].filter(u => u.break > 0).sort((a, b) => b.break - a.break);
                typeClass = 'amber-400'; valKey = 'break';
            } else if (type === 'break-least') {
                titleEl.textContent = 'Leaderboard: Least Break Time';
                sorted = [...allRankings].filter(u => u.work > 0).sort((a, b) => a.break - b.break);
                typeClass = 'sky-400'; valKey = 'break';
            }

            const fmt = ms => {
                const h = Math.floor(ms / 3600000);
                const m = Math.floor((ms % 3600000) / 60000);
                return `${h}h ${m}m`;
            };

            if (!sorted.length) {
                listEl.innerHTML = '<div class="text-white/40 text-sm text-center py-6 border border-white/5 border-dashed rounded-xl bg-white/5">No data available yet.</div>';
            } else {
                listEl.innerHTML = sorted.map((u, i) => `
                    <div class="flex items-center gap-4 p-3 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 transition-colors">
                        <div class="text-${typeClass} font-bold w-6 text-center text-lg">${i + 1}.</div>
                        <div class="avatar" style="width:36px;height:36px;font-size:14px">${u.avatar ? `<img src="${u.avatar}" class="w-full h-full object-cover">` : initials(u.full_name)}</div>
                        <div class="flex-1 text-sm text-white font-medium break-words">${esc(u.full_name)}</div>
                        <div class="text-${typeClass} font-mono font-bold text-sm bg-black/20 px-3 py-1.5 rounded-lg border border-white/5 shadow-inner">${fmt(u[valKey])}</div>
                    </div>
                `).join('');
            }
            openModal('modal-top');
        }

        async function loadAttendance() {
            const body = document.getElementById('attend-body');
            const { data: att } = await sb.from('attendance').select('*,profiles(full_name,avatar_url)').eq('company_id', myProfile.company_id).order('updated_at', { ascending: false });
            // Only show latest record per user
            const seen = new Set(), rows = [];
            (att || []).forEach(r => { if (!seen.has(r.user_id)) { seen.add(r.user_id); rows.push(r) } });
            if (!rows.length) { body.innerHTML = '<tr><td colspan="7" class="text-center text-white/40 py-4">No attendance records yet.</td></tr>'; }
            const statusMeta = { in: { cls: 'badge-in', dot: '#10b981', label: 'Clocked In' }, break_in: { cls: 'badge-in', dot: '#10b981', label: 'Clocked In' }, break: { cls: 'badge-break', dot: '#f59e0b', label: 'On Break' }, out: { cls: 'badge-out', dot: '#94a3b8', label: 'Out' } };

            // Fetch today's full logs for calculations
            const today = new Date().toISOString().slice(0, 10);
            const { data: allLogs } = await sb.from('attendance').select('*').eq('company_id', myProfile.company_id).gte('created_at', today + 'T00:00:00').order('created_at', { ascending: true });

            const stats = {};
            const groupedLogs = {}; // To store today's logs for the timeline modal
            (allLogs || []).forEach((log, i) => {
                if (!stats[log.user_id]) {
                    stats[log.user_id] = { work: 0, break: 0, breakCount: 0, inTime: '—', outTime: '—' };
                    groupedLogs[log.user_id] = [];
                }
                groupedLogs[log.user_id].push(log);

                // Track First In and Last Out
                if (log.status === 'in' && stats[log.user_id].inTime === '—') {
                    stats[log.user_id].inTime = new Date(log.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
                if (log.status === 'out') {
                    stats[log.user_id].outTime = new Date(log.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }

                const nextLog = allLogs.find((L, idx) => idx > i && L.user_id === log.user_id);
                const endTime = nextLog ? new Date(nextLog.created_at) : new Date();
                const duration = endTime - new Date(log.created_at);

                if (log.status === 'in' || log.status === 'break_in') stats[log.user_id].work += duration;
                if (log.status === 'break') {
                    stats[log.user_id].break += duration;
                    stats[log.user_id].breakCount++;
                }
            });
            window.liveAttendanceLogs = groupedLogs; // Store globally for the modal


            const fmt = ms => {
                const h = Math.floor(ms / 3600000);
                const m = Math.floor((ms % 3600000) / 60000);
                return `${h}h ${m}m`;
            };

            // Store globally for exports before averages calc
            currentAttendRows = rows;
            currentAttendStats = stats;

            // Calculate Averages
            const staffWithLogs = Object.keys(stats);
            if (staffWithLogs.length > 0) {
                const totalWork = staffWithLogs.reduce((acc, id) => acc + stats[id].work, 0);
                const totalBreak = staffWithLogs.reduce((acc, id) => acc + stats[id].break, 0);
                document.getElementById('stat-avg-work').textContent = fmt(totalWork / staffWithLogs.length);
                document.getElementById('stat-avg-break').textContent = fmt(totalBreak / staffWithLogs.length);
            }

            // Compile & Render Top 5 Rankings
            allRankings = Object.keys(stats).map(uid => {
                const p = att?.find(r => r.user_id === uid)?.profiles || {};
                return {
                    user_id: uid,
                    full_name: p.full_name || '—',
                    avatar: p.avatar_url || null,
                    work: stats[uid].work,
                    break: stats[uid].break
                };
            });

            function renderTopList(elementId, sortedList, typeClass, valueKey) {
                const el = document.getElementById(elementId);
                if (!el) return;
                if (!sortedList.length) { el.innerHTML = '<div class="text-white/40 text-xs text-center border border-white/5 border-dashed rounded-lg p-4 bg-black/10">No data today.</div>'; return; }
                el.innerHTML = sortedList.slice(0, 5).map((u, i) => `
                    <div class="flex items-center gap-3 p-2 rounded-xl bg-black/20 border border-white/5 hover:bg-black/40 transition-colors">
                        <div class="text-${typeClass} font-bold text-xs w-4 text-center">${i + 1}.</div>
                        <div class="avatar" style="width:28px;height:28px;font-size:10px">${u.avatar ? `<img src="${u.avatar}" class="w-full h-full object-cover">` : initials(u.full_name)}</div>
                        <div class="flex-1 text-sm text-white truncate font-medium">${esc(u.full_name)}</div>
                        <div class="text-${typeClass} font-mono text-xs font-bold leading-tight bg-white/5 px-2 py-1 rounded-md text-right min-w-[50px]">${fmt(u[valueKey])}</div>
                    </div>
                `).join('');
            }

            const workSorted = [...allRankings].filter(u => u.work > 0).sort((a, b) => b.work - a.work);
            const breakMostSorted = [...allRankings].filter(u => u.break > 0).sort((a, b) => b.break - a.break);
            const breakLeastSorted = [...allRankings].filter(u => u.work > 0).sort((a, b) => a.break - b.break); // Filter out users who didn't work today so they don't show up with 0 break

            renderTopList('top5-work', workSorted, 'emerald-400', 'work');
            renderTopList('top5-break-most', breakMostSorted, 'amber-400', 'break');
            renderTopList('top5-break-least', breakLeastSorted, 'sky-400', 'break');

            if (rows.length) {
                body.innerHTML = rows.map(r => {
                    const m = statusMeta[r.status] || statusMeta.out;
                    const loc = r.latitude ? `${parseFloat(r.latitude).toFixed(3)},${parseFloat(r.longitude).toFixed(3)}` : '—';
                    const s = stats[r.user_id] || { work: 0, break: 0, breakCount: 0 };
                    return `<tr onclick="openLiveTimeline('${r.user_id}')" class="cursor-pointer hover:bg-white/5 transition-colors" title="Click to view full timeline">
          <td>
        <div class="flex items-center gap-2">
            <div class="avatar">${initials(r.profiles?.full_name)}</div>
            <div>
                <span class="text-white text-sm font-medium">${esc(r.profiles?.full_name || '—')}</span>
                <div class="flex items-center gap-1 mt-0.5">
                    <span class="pulse-dot" style="background:${m.dot}"></span>
                    <span class="text-[10px] uppercase font-bold" style="color:${m.dot}">${m.label}</span>
                </div>
            </div>
        </div>
      </td>
      <td class="text-emerald-400 font-mono text-xs">${s.inTime}</td>
      <td class="text-white/40 font-mono text-xs">${s.outTime}</td>
      <td class="text-emerald-400 font-semibold">${fmt(s.work)}</td>
      <td class="text-amber-400 font-semibold">${fmt(s.break)} <span class="text-white/30 text-[10px] ml-1 font-normal">(${s.breakCount}x)</span></td>
      <td class="font-mono text-white/50 text-xs">${esc(r.ip_address || '—')}</td>
      <td class="text-white/50 text-xs">${loc}</td>
        </tr>`;
                }).join('');
            }


            // Realtime
            if (attendRtSub) sb.removeChannel(attendRtSub);
            attendRtSub = sb.channel('attend-rt')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'attendance', filter: `company_id=eq.${myProfile.company_id}` }, () => loadAttendance())
                .subscribe();
        }

        function openLiveTimeline(userId) {
            const records = window.liveAttendanceLogs?.[userId];
            const profile = myStaff.find(u => u.id === userId);
            if (!records || !profile) return;

            const fakeIdx = 999; // temporary index for live data
            window.lastReportSummary = window.lastReportSummary || [];
            window.lastReportSummary[fakeIdx] = {
                full_name: profile.full_name || '—',
                date: "Today's Live Activity",
                records: records
            };
            openReportDetails(fakeIdx);
        }

        // ── NOTIFICATIONS ──
        let allNotifs = [];
        async function loadNotifs() {
            const list = document.getElementById('notif-list');
            list.innerHTML = `<div class="text-white/40 text-sm">Loading…</div>`;

            const filterType = document.getElementById('notif-filter').value;
            const customDates = document.getElementById('notif-custom-dates');
            if (filterType === 'custom') customDates.classList.remove('hidden');
            else customDates.classList.add('hidden');

            let query = sb
                .from('notifications')
                .select('*,target:profiles!notifications_target_user_id_fkey(full_name),notification_reads(user_id,read_at,profiles!notification_reads_user_id_fkey(full_name))')
                .eq('company_id', myProfile.company_id);

            const range = getRange(filterType, 'notif-start', 'notif-end');
            if (range.start) query = query.gte('created_at', range.start.toISOString());
            if (range.end) query = query.lte('created_at', range.end.toISOString());

            const { data, error } = await query.order('created_at', { ascending: false });

            if (error) {
                console.error('Load Notifs Error:', error);
                list.innerHTML = `<div class="text-red-400 text-sm">Failed to load: ${error.message}</div>`;
                return;
            }

            allNotifs = data || [];
            if (!allNotifs.length) { list.innerHTML = '<div class="text-white/40 text-sm">No notifications sent yet.</div>'; return }
            list.innerHTML = '';
            allNotifs.forEach(n => {
                const readCount = n.notification_reads?.length || 0;
                const el = document.createElement('div');
                el.className = 'notif-preview p-4 rounded-2xl bg-white/5 border border-white/10 space-y-3';

                let attachmentHtml = '';
                if (n.attachment_url) {
                    const isImg = n.attachment_type === 'image' || /\.(jpg|jpeg|png|gif|webp)$/i.test(n.attachment_url);
                    if (isImg) attachmentHtml = `<img src="${n.attachment_url}" onclick="openFullView('${n.attachment_url}')" class="w-full max-h-64 object-cover rounded-lg border border-white/10 cursor-zoom-in hover:brightness-110 transition-all mt-2" />`;
                    else if (n.attachment_type === 'link') attachmentHtml = `<a href="${n.attachment_url}" target="_blank" class="flex items-center gap-2 text-sky-400 text-xs truncate underline mt-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>View Link</a>`;
                    else attachmentHtml = `<a href="${n.attachment_url}" target="_blank" class="flex items-center gap-2 text-amber-400 text-xs truncate underline mt-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>Download File</a>`;
                }

                el.innerHTML = `
      <div class="flex items-start gap-3 w-full">
        <div class="pt-1 flex-shrink-0">
          <input type="checkbox" class="bulk-item-check notifs-checkbox" value="${n.id}" onclick="updateBulkBar()">
        </div>
        <div class="flex-1 min-w-0">
          <div class="flex items-start justify-between gap-3">
            <div class="flex-1">
              <div class="flex items-center gap-2 flex-wrap">
                <div class="text-white font-semibold text-sm">${esc(n.title)}</div>
                ${n.target_user_id ? `<span class="bg-violet-500/20 text-violet-400 text-[10px] px-2 py-0.5 rounded-full border border-violet-500/30">Direct to ${esc(n.target?.full_name || 'Staff')}</span>` : '<span class="bg-emerald-500/20 text-emerald-400 text-[10px] px-2 py-0.5 rounded-full border border-emerald-500/30">Company Wide</span>'}
              </div>
              <div class="text-white/60 text-sm mt-1 whitespace-pre-wrap">${esc(n.body || '')}</div>
              ${attachmentHtml}
              <div class="text-white/30 text-xs mt-2">${timeAgo(n.created_at)}</div>
            </div>
            <div class="flex flex-col gap-2 flex-shrink-0 items-end">
                <button onclick="showSeen('${n.id}','${esc(n.title)}')" class="seen-pill text-nowrap">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                Seen ${readCount}
                </button>
                <div class="flex gap-2">
                    <button onclick="openEditNotif('${n.id}')" class="p-1.5 rounded-lg bg-white/5 text-white/40 hover:text-sky-400 hover:bg-sky-400/10 transition-colors cursor-pointer" title="Edit">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                    </button>
                    <button onclick="deleteNotif('${n.id}')" class="p-1.5 rounded-lg bg-white/5 text-white/40 hover:text-red-400 hover:bg-red-400/10 transition-colors cursor-pointer" title="Delete">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    </button>
                </div>
            </div>
          </div>
        </div>
      </div>`;
                list.appendChild(el);
            });
        }

        // ─── MULTI-STAFF PICKER HELPERS ──────────────────────────────────────
        function buildStaffPicker(prefix, staffList) {
            const listEl = document.getElementById(`${prefix}-picker-list`);
            if (!listEl) return;
            // Keep the "All Staff" checkbox, then add one per staff member
            listEl.innerHTML = `
              <label class="sp-item">
                <input type="checkbox" id="${prefix}-chk-all" value="all" onchange="onStaffPickerAll('${prefix}', this)" checked />
                Company Wide (All Staff)
              </label>` +
                staffList.map(s => `
              <label class="sp-item" data-name="${(s.full_name || s.username || '').toLowerCase()}">
                <input type="checkbox" class="${prefix}-staff-chk" value="${s.id}" onchange="onStaffPickerItem('${prefix}', this)" />
                ${esc(s.full_name || s.username)}
              </label>`).join('');
            updateStaffPickerLabel(prefix);
        }

        function toggleStaffPicker(prefix) {
            const btn = document.getElementById(`${prefix}-picker-btn`);
            const dd = document.getElementById(`${prefix}-picker-dropdown`);
            const isOpen = dd.classList.contains('open');
            // Close any other open pickers first
            document.querySelectorAll('.staff-picker-dropdown.open').forEach(el => el.classList.remove('open'));
            document.querySelectorAll('.staff-picker-btn.open').forEach(el => el.classList.remove('open'));
            if (!isOpen) { dd.classList.add('open'); btn.classList.add('open'); }
        }

        // Close picker when clicking outside
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.staff-picker')) {
                document.querySelectorAll('.staff-picker-dropdown.open').forEach(el => el.classList.remove('open'));
                document.querySelectorAll('.staff-picker-btn.open').forEach(el => el.classList.remove('open'));
            }
        });

        function filterStaffPicker(prefix, query) {
            const q = query.toLowerCase();
            document.querySelectorAll(`#${prefix}-picker-list .sp-item[data-name]`).forEach(el => {
                el.style.display = el.dataset.name.includes(q) ? '' : 'none';
            });
        }

        function onStaffPickerAll(prefix, chk) {
            if (chk.checked) {
                // Deselect all individual staff
                document.querySelectorAll(`.${prefix}-staff-chk`).forEach(c => c.checked = false);
            }
            updateStaffPickerLabel(prefix);
        }

        function onStaffPickerItem(prefix, chk) {
            const allChk = document.getElementById(`${prefix}-chk-all`);
            if (chk.checked && allChk) allChk.checked = false;
            // If nothing selected, revert to "All"
            const anyChecked = [...document.querySelectorAll(`.${prefix}-staff-chk`)].some(c => c.checked);
            if (!anyChecked && allChk) allChk.checked = true;
            updateStaffPickerLabel(prefix);
        }

        function updateStaffPickerLabel(prefix) {
            const labelEl = document.getElementById(`${prefix}-picker-label`);
            if (!labelEl) return;
            const allChk = document.getElementById(`${prefix}-chk-all`);
            if (allChk && allChk.checked) { labelEl.innerHTML = 'Company Wide (All Staff)'; return; }
            const checked = [...document.querySelectorAll(`.${prefix}-staff-chk`)].filter(c => c.checked);
            if (checked.length === 0) { labelEl.innerHTML = 'Company Wide (All Staff)'; return; }
            labelEl.innerHTML = checked.map(c => {
                const name = c.closest('label')?.textContent.trim() || c.value;
                return `<span class="sp-badge">${esc(name)}</span>`;
            }).join(' ');
        }

        function getStaffPickerValues(prefix) {
            const allChk = document.getElementById(`${prefix}-chk-all`);
            if (allChk && allChk.checked) return ['all'];
            const checked = [...document.querySelectorAll(`.${prefix}-staff-chk`)].filter(c => c.checked).map(c => c.value);
            return checked.length ? checked : ['all'];
        }

        function resetStaffPicker(prefix) {
            document.querySelectorAll(`.${prefix}-staff-chk`).forEach(c => c.checked = false);
            const allChk = document.getElementById(`${prefix}-chk-all`);
            if (allChk) allChk.checked = true;
            updateStaffPickerLabel(prefix);
        }
        // ─────────────────────────────────────────────────────────────────────

        async function sendNotif() {
            const btn = document.querySelector('button[onclick="sendNotif()"]');
            const title = document.getElementById('notif-title').value.trim();
            const body = document.getElementById('notif-body').value.trim();
            const attType = document.getElementById('notif-att-type').value || null;
            const attUrl = document.getElementById('notif-att-url').value.trim() || null;
            const msg = document.getElementById('notif-msg');

            // Collect selected targets from multi-select picker
            const targets = getStaffPickerValues('notif'); // ['all'] or ['uuid1','uuid2',...]

            if (!title) { alert('Title is required'); return; }
            if (!targets.length) { alert('Please select at least one recipient.'); return; }

            btn.disabled = true;
            btn.textContent = 'Sending…';

            try {
                let rows;
                if (targets.includes('all')) {
                    // Single broadcast notification
                    rows = [{ company_id: myProfile.company_id, title, body: body || null, created_by: myUser.id, target_user_id: null, attachment_url: attUrl, attachment_type: attType }];
                } else {
                    // One row per selected staff member
                    rows = targets.map(uid => ({ company_id: myProfile.company_id, title, body: body || null, created_by: myUser.id, target_user_id: uid, attachment_url: attUrl, attachment_type: attType }));
                }

                const { error } = await sb.from('notifications').insert(rows);

                if (error) {
                    console.error('Notification Insert Error:', error);
                    alert('Error: ' + error.message);
                } else {
                    document.getElementById('notif-title').value = '';
                    document.getElementById('notif-body').value = '';
                    document.getElementById('notif-att-url').value = '';
                    document.getElementById('notif-att-type').value = '';
                    resetStaffPicker('notif');

                    const count = targets.includes('all') ? 'all staff' : `${targets.length} staff member${targets.length > 1 ? 's' : ''}`;
                    msg.textContent = `✅ Notification sent to ${count}!`;
                    msg.classList.remove('hidden');
                    setTimeout(() => msg.classList.add('hidden'), 3500);
                    await loadNotifs();
                }
            } catch (err) {
                console.error('Unexpected error:', err);
                alert('Something went wrong. Check the console.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send Notification';
            }
        }


        function openEditNotif(id) {
            const n = allNotifs.find(x => x.id === id);
            if (!n) return;
            document.getElementById('edit-notif-id').value = n.id;
            document.getElementById('edit-notif-title').value = n.title;
            document.getElementById('edit-notif-body').value = n.body || '';
            document.getElementById('edit-notif-target').value = n.target_user_id || 'all';
            document.getElementById('edit-notif-att-type').value = n.attachment_type || '';
            document.getElementById('edit-notif-att-url').value = n.attachment_url || '';
            openModal('modal-edit-notif');
        }

        async function updateNotif() {
            const id = document.getElementById('edit-notif-id').value;
            const updateData = {
                title: document.getElementById('edit-notif-title').value.trim(),
                body: document.getElementById('edit-notif-body').value.trim(),
                target_user_id: document.getElementById('edit-notif-target').value === 'all' ? null : document.getElementById('edit-notif-target').value,
                attachment_type: document.getElementById('edit-notif-att-type').value || null,
                attachment_url: document.getElementById('edit-notif-att-url').value.trim() || null
            };
            if (!updateData.title) return;
            const { error } = await sb.from('notifications').update(updateData).eq('id', id);
            if (error) {
                console.error('Update Notif Error:', error);
                alert('Update failed: ' + error.message);
                return;
            }
            closeModal('modal-edit-notif');
            await loadNotifs();
        }

        async function deleteNotif(id) {
            if (!confirm('Delete this notification for everyone?')) return;
            const { error } = await sb.from('notifications').delete().eq('id', id);
            if (error) {
                console.error('Delete Notif Error:', error);
                alert('Delete failed: ' + error.message);
                return;
            }
            await loadNotifs();
        }

        async function showSeen(notifId, title) {
            const { data } = await sb.from('notification_reads').select('read_at,profiles(full_name)').eq('notification_id', notifId).order('read_at', { ascending: false });
            const list = document.getElementById('seen-list');
            if (!data?.length) { list.innerHTML = '<div class="text-white/40 text-sm text-center py-4">No one has read this yet.</div>'; }
            else {
                list.innerHTML = data.map(r => `
                    < div class="flex items-center gap-3 py-2 border-b border-white/5" >
        <div class="avatar" style="width:32px;height:32px;font-size:12px">${initials(r.profiles?.full_name)}</div>
        <div class="flex-1"><div class="text-white text-sm font-medium">${esc(r.profiles?.full_name || '—')}</div><div class="text-white/40 text-xs">${new Date(r.read_at).toLocaleString()}</div></div>
      </div > `).join('');
            }
            openModal('modal-seen');
        }

        // ── SOCIAL WALL (ADMIN) ──
        function openFullView(url) {
            document.getElementById('full-view-img').src = url;
            openModal('modal-full-view');
        }

        function previewImage(input) {
            const file = input.files[0];
            if (!file) return;
            const preview = document.getElementById('image-preview');
            const wrap = document.getElementById('image-preview-wrap');
            const name = document.getElementById('image-name');
            const reader = new FileReader();
            reader.onload = e => {
                preview.src = e.target.result;
                wrap.classList.remove('hidden');
                name.textContent = file.name;
                name.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function clearImagePreview() {
            document.getElementById('post-image').value = '';
            document.getElementById('image-preview-wrap').classList.add('hidden');
            document.getElementById('image-name').classList.add('hidden');
        }

        async function submitPost() {
            const btn = document.getElementById('post-btn');
            const content = document.getElementById('post-content').value.trim();
            const file = document.getElementById('post-image').files[0];
            if (!content && !file) return;

            btn.disabled = true;
            btn.textContent = 'Posting…';
            let image_url = null;

            try {
                if (file) {
                    const ext = file.name.split('.').pop();
                    const path = `${myUser.id}/${Date.now()}.${ext}`;
                    const { error: upErr } = await sb.storage.from('post-images').upload(path, file, { upsert: true });
                    if (!upErr) {
                        const { data: pub } = sb.storage.from('post-images').getPublicUrl(path);
                        image_url = pub.publicUrl;
                    }
                }

                const { error } = await sb.from('posts').insert({
                    company_id: myProfile.company_id,
                    author_id: myUser.id,
                    content,
                    image_url
                });

                if (error) throw error;

                document.getElementById('post-content').value = '';
                clearImagePreview();
                await loadWall();
            } catch (err) {
                console.error('Post Error:', err);
                alert('Failed to post: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Post Update';
            }
        }

        async function loadWall() {
            const wall = document.getElementById('admin-wall');
            wall.innerHTML = '<div class="text-white/40 text-sm">Loading…</div>';

            const filterType = document.getElementById('wall-filter').value;
            const customDates = document.getElementById('wall-custom-dates');
            if (filterType === 'custom') customDates.classList.remove('hidden');
            else customDates.classList.add('hidden');

            let query = sb
                .from('posts')
                .select('*,profiles(full_name,avatar_url),post_likes(user_id),post_comments(id,content,created_at,profiles(full_name))')
                .eq('company_id', myProfile.company_id);

            const range = getRange(filterType, 'wall-start', 'wall-end');
            if (range.start) query = query.gte('created_at', range.start.toISOString());
            if (range.end) query = query.lte('created_at', range.end.toISOString());

            const { data: posts } = await query
                .order('created_at', { ascending: false })
                .limit(50);
            if (!posts?.length) { wall.innerHTML = '<div class="text-white/40 text-sm">No posts yet.</div>'; return }
            wall.innerHTML = '';
            posts.forEach(p => {
                const el = document.createElement('div');
                el.className = 'post-card fade-in';
                el.id = 'wpost-' + p.id;
                const isLiked = p.post_likes?.some(l => l.user_id === myUser.id);
                const likeCount = p.post_likes?.length || 0;
                const commentCount = p.post_comments?.length || 0;
                const authorName = p.profiles?.full_name || 'User';
                const commentsHtml = (p.post_comments || []).map(c => `
                    <div class="flex items-start gap-2">
                        <div class="avatar" style="width:28px;height:28px;font-size:11px">${initials(c.profiles?.full_name)}</div>
                        <div class="flex-1 px-3 py-2" style="background:rgba(255,255,255,0.05);border-radius:10px">
                            <div class="text-white/70 text-xs font-semibold">${esc(c.profiles?.full_name || 'User')}</div>
                            <div class="text-white/80 text-sm">${esc(c.content)}</div>
                        </div>
                    </div>`).join('');
                el.innerHTML = `
      <div class="flex items-start gap-4 w-full">
        <div class="pt-1 flex-shrink-0">
          <input type="checkbox" class="bulk-item-check wall-checkbox" value="${p.id}" onclick="updateBulkBar()">
        </div>
        <div class="flex-1 min-w-0">
          <!-- Header: avatar + name + delete -->
          <div class="flex items-start justify-between gap-3">
            <div class="flex items-center gap-3">
              <div class="avatar">${p.profiles?.avatar_url ? `<img src="${p.profiles.avatar_url}" class="w-full h-full rounded-full object-cover">` : initials(authorName)}</div>
              <div>
                <div class="font-semibold text-white text-sm">${esc(authorName)}</div>
                <div class="text-white/30 text-[10px]">${timeAgo(p.created_at)}</div>
              </div>
            </div>
            <button onclick="deletePost('${p.id}')" class="p-1.5 rounded-lg bg-white/5 text-white/40 hover:text-red-400 hover:bg-red-400/10 transition-colors cursor-pointer">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
          <!-- Image FIRST -->
          ${p.image_url ? `<div class="mt-3 -mx-0 rounded-xl overflow-hidden border border-white/10 cursor-zoom-in" onclick="openFullView('${p.image_url}')">
            <img src="${p.image_url}" class="w-full max-h-80 object-cover hover:scale-[1.02] transition-transform duration-300" loading="lazy"/>
          </div>` : ''}
          <!-- Text SECOND with Read More -->
          ${p.content ? (() => {
                        const full = esc(p.content);
                        const limit = 150;
                        if (p.content.length <= limit) {
                            return `<p class="text-white/80 text-sm mt-3 leading-relaxed whitespace-pre-wrap">${full}</p>`;
                        }
                        const preview = esc(p.content.slice(0, limit));
                        return `<div class="mt-3">
              <p class="text-white/80 text-sm leading-relaxed whitespace-pre-wrap" id="wtext-${p.id}">${preview}<span class="text-white/40">…</span></p>
              <p class="text-white/80 text-sm leading-relaxed whitespace-pre-wrap hidden" id="wtext-full-${p.id}">${full}</p>
              <button onclick="toggleReadMore('${p.id}')" id="wread-btn-${p.id}" class="text-[11px] font-semibold mt-1 text-violet-400 hover:text-violet-300 transition-colors">Read more</button>
            </div>`;
                    })() : ''}
          <!-- Actions -->
          <div class="flex items-center gap-3 mt-4 flex-wrap">
            <button class="like-btn ${isLiked ? 'liked' : ''}" id="wlike-btn-${p.id}" onclick="toggleAdminLike('${p.id}', ${isLiked})">
              <svg class="w-3.5 h-3.5" fill="${isLiked ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
              <span id="wlike-count-${p.id}">${likeCount}</span> ${likeCount === 1 ? 'Like' : 'Likes'}
            </button>
            <button class="like-btn" onclick="toggleAdminComments('${p.id}')">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
              ${commentCount} ${commentCount === 1 ? 'Comment' : 'Comments'}
            </button>
          </div>
          <div id="wcomments-${p.id}" class="hidden mt-4 space-y-2 border-t border-white/5 pt-4">
            <div class="space-y-2" id="wcomment-list-${p.id}">${commentsHtml}</div>
            <div class="flex gap-2 mt-3">
              <input type="text" id="wcomment-input-${p.id}" class="comment-input flex-1" placeholder="Write a comment…" onkeydown="if(event.key==='Enter') addAdminComment('${p.id}')"/>
              <button onclick="addAdminComment('${p.id}')" class="btn btn-primary btn-sm">Send</button>
            </div>
          </div>
        </div>
      </div>`;
                wall.appendChild(el);
            });
        }

        function toggleAdminComments(postId) {
            document.getElementById('wcomments-' + postId).classList.toggle('hidden');
        }

        function toggleReadMore(postId) {
            const preview = document.getElementById('wtext-' + postId);
            const full = document.getElementById('wtext-full-' + postId);
            const btn = document.getElementById('wread-btn-' + postId);
            const isExpanded = full.classList.contains('hidden');
            preview.classList.toggle('hidden', isExpanded);
            full.classList.toggle('hidden', !isExpanded);
            btn.textContent = isExpanded ? 'Show less' : 'Read more';
        }

        async function toggleAdminLike(postId, isLiked) {
            const btn = document.getElementById('wlike-btn-' + postId);
            const countEl = document.getElementById('wlike-count-' + postId);
            if (isLiked) {
                await sb.from('post_likes').delete().eq('post_id', postId).eq('user_id', myUser.id);
                btn.classList.remove('liked');
                btn.querySelector('svg').setAttribute('fill', 'none');
                const newCount = Math.max(0, parseInt(countEl.textContent) - 1);
                countEl.textContent = newCount;
                btn.setAttribute('onclick', `toggleAdminLike('${postId}', false)`);
            } else {
                await sb.from('post_likes').insert({ post_id: postId, user_id: myUser.id });
                btn.classList.add('liked');
                btn.querySelector('svg').setAttribute('fill', 'currentColor');
                const newCount = parseInt(countEl.textContent) + 1;
                countEl.textContent = newCount;
                btn.setAttribute('onclick', `toggleAdminLike('${postId}', true)`);
            }
        }

        async function addAdminComment(postId) {
            const inp = document.getElementById('wcomment-input-' + postId);
            const content = inp.value.trim();
            if (!content) return;
            inp.value = '';
            const { data, error } = await sb.from('post_comments').insert({
                post_id: postId, author_id: myUser.id, content
            }).select('*, profiles(full_name)').single();
            if (error || !data) return;
            const list = document.getElementById('wcomment-list-' + postId);
            list.insertAdjacentHTML('beforeend', `
                <div class="flex items-start gap-2">
                    <div class="avatar" style="width:28px;height:28px;font-size:11px">${initials(myProfile.full_name)}</div>
                    <div class="flex-1 px-3 py-2" style="background:rgba(255,255,255,0.05);border-radius:10px">
                        <div class="text-white/70 text-xs font-semibold">${esc(myProfile.full_name || 'Admin')}</div>
                        <div class="text-white/80 text-sm">${esc(content)}</div>
                    </div>
                </div>`);
        }

        async function deletePost(id) {
            if (!confirm('Delete this post?')) return;
            await sb.from('posts').delete().eq('id', id);
            document.getElementById('wpost-' + id)?.remove();
        }

        // ── REPORTS / CSV ──
        async function loadReport() {
            const userId = document.getElementById('rpt-user')?.value || 'all';
            const from = document.getElementById('rpt-from').value;
            const to = document.getElementById('rpt-to').value;

            let q = sb.from('attendance').select('*,profiles(full_name)').eq('company_id', myProfile.company_id).order('created_at', { ascending: true });

            if (userId !== 'all') q = q.eq('user_id', userId);
            if (from) q = q.gte('created_at', from + 'T00:00:00');
            if (to) q = q.lte('created_at', to + 'T23:59:59');

            const { data, error } = await q;
            if (error) { console.error('Report Error:', error); return []; }

            const tz = myCompany?.timezone || 'UTC';
            const grouped = {};
            (data || []).forEach(r => {
                const dateKey = new Date(r.created_at).toLocaleDateString('en-CA', { timeZone: tz });
                const key = r.user_id + '_' + dateKey;
                if (!grouped[key]) {
                    grouped[key] = {
                        user_id: r.user_id,
                        full_name: r.profiles?.full_name || '—',
                        date: dateKey,
                        inTime: '—',
                        outTime: '—',
                        workMs: 0,
                        breakMs: 0,
                        breakCount: 0,
                        records: []
                    };
                }
                grouped[key].records.push(r);
            });

            const summary = Object.values(grouped).map(g => {
                const logs = g.records;
                for (let i = 0; i < logs.length; i++) {
                    const log = logs[i];
                    if (log.status === 'in' && g.inTime === '—') g.inTime = new Date(log.created_at).toLocaleTimeString('en-US', { timeZone: tz });
                    if (log.status === 'out') g.outTime = new Date(log.created_at).toLocaleTimeString('en-US', { timeZone: tz });

                    const nextLog = logs[i + 1];
                    const endTime = nextLog ? new Date(nextLog.created_at) : (log.status !== 'out' ? new Date() : null);

                    if (endTime) {
                        const duration = endTime - new Date(log.created_at);
                        if (log.status === 'in' || log.status === 'break_in') g.workMs += duration;
                        if (log.status === 'break') {
                            g.breakMs += duration;
                            g.breakCount++;
                        }
                    }
                }
                return g;
            });
            summary.sort((a, b) => new Date(b.date) - new Date(a.date));

            const fmt = ms => {
                const h = Math.floor(ms / 3600000);
                const m = Math.floor((ms % 3600000) / 60000);
                return `${h}h ${m}m`;
            };

            const body = document.getElementById('rpt-body');
            if (!summary.length) { body.innerHTML = '<tr><td colspan="6" class="text-center text-white/40 py-4">No records found.</td></tr>'; return [] }

            window.lastReportSummary = summary;
            body.innerHTML = summary.map((g, i) => `<tr onclick="openReportDetails(${i})" class="cursor-pointer hover:bg-white/5 transition-colors" title="Click to view full timeline">
      <td class="text-white text-sm py-3">${esc(g.full_name)}</td>
      <td class="text-white/60 text-xs">${g.date}</td>
      <td class="text-emerald-400 font-mono text-xs">${g.inTime}</td>
      <td class="text-white/40 font-mono text-xs">${g.outTime}</td>
      <td class="text-emerald-400 font-semibold">${fmt(g.workMs)}</td>
      <td class="text-amber-400 font-semibold">${fmt(g.breakMs)} <span class="text-white/30 text-[10px] ml-1 font-normal">(${g.breakCount}x)</span></td>
    </tr>`).join('');

            return summary;
        }

        function openReportDetails(idx) {
            const g = window.lastReportSummary[idx];
            if (!g) return;

            document.getElementById('modal-report-title').textContent = `${g.full_name} • ${g.date}`;
            const list = document.getElementById('modal-report-list');

            if (!g.records || !g.records.length) {
                list.innerHTML = '<div class="text-white/40 text-sm text-center py-6 border border-white/5 border-dashed rounded-xl bg-white/5">No records found.</div>';
            } else {
                const tz = myCompany?.timezone || 'UTC';
                const statusMeta = {
                    in: { label: 'Clock In', cls: 'text-emerald-400', bg: 'bg-emerald-500/10 border-emerald-500/20' },
                    break_in: { label: 'Return from Break', cls: 'text-emerald-400', bg: 'bg-emerald-500/10 border-emerald-500/20' },
                    break: { label: 'Break Started', cls: 'text-amber-400', bg: 'bg-amber-500/10 border-amber-500/20' },
                    out: { label: 'Clock Out', cls: 'text-sky-400', bg: 'bg-sky-500/10 border-sky-500/20' }
                };

                list.innerHTML = g.records.map(r => {
                    const time = new Date(r.created_at).toLocaleTimeString('en-US', { timeZone: tz, hour: 'numeric', minute: '2-digit', second: '2-digit' });
                    const m = statusMeta[r.status] || { label: r.status, cls: 'text-white', bg: 'bg-white/5 border-white/10' };
                    const loc = r.latitude ? `<div><span class="text-white/30">Loc:</span> ${parseFloat(r.latitude).toFixed(3)}, ${parseFloat(r.longitude).toFixed(3)}</div>` : '';
                    const ip = r.ip_address ? `<div><span class="text-white/30">IP:</span> ${esc(r.ip_address)}</div>` : '';

                    return `<div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 p-3 rounded-xl ${m.bg} border transition-colors">
                        <div>
                            <div class="font-bold text-[13px] ${m.cls} mb-1">${m.label}</div>
                            <div class="text-[10px] text-white/50 font-mono flex gap-3">${ip}${loc}</div>
                        </div>
                        <div class="text-white/90 font-mono text-xs bg-black/20 px-3 py-1.5 rounded-lg border border-white/5 shadow-inner shrink-0">${time}</div>
                    </div>`;
                }).join('');
            }
            openModal('modal-report-details');
        }

        async function downloadCSV() {
            const msg = document.getElementById('rpt-msg');
            msg.textContent = 'Fetching data…'; msg.classList.remove('hidden');
            const summary = await loadReport();
            if (!summary?.length) { msg.textContent = 'No records to export.'; return }

            const headers = ['Staff', 'Date', 'Clock In', 'Clock Out', 'Work Time', 'Break Time', 'Break Count'];
            const fmt = ms => {
                const h = Math.floor(ms / 3600000);
                const m = Math.floor((ms % 3600000) / 60000);
                return `${h}h ${m}m`;
            };

            const rows = summary.map(g => [
                (g.full_name || '—').replace(/,/g, ''),
                g.date,
                g.inTime,
                g.outTime,
                fmt(g.workMs),
                fmt(g.breakMs),
                g.breakCount
            ]);

            const csvContent = "data:text/csv;charset=utf-8," + [headers, ...rows].map(e => e.join(",")).join("\n");
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `attendance_summary_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            link.remove();

            msg.textContent = '✅ CSV downloaded!';
            setTimeout(() => msg.classList.add('hidden'), 3000);
        }

        // ── SETTINGS ──
        const themes = [
            { id: 'theme-1', name: 'Premium Dark', primary: '#6c63ff', accent: '#2dd4bf', bg: '#0d0d1a', gradient: 'linear-gradient(135deg, #0f0c29 0%, #302b63 40%, #24243e 100%)', orbs: true },
            { id: 'theme-2', name: 'Deep Space', primary: '#38bdf8', accent: '#818cf8', bg: '#020617', gradient: 'linear-gradient(180deg, #0f172a 0%, #020617 100%)', orbs: true },
            { id: 'theme-3', name: 'Emerald Night', primary: '#34d399', accent: '#059669', bg: '#064e3b', gradient: 'linear-gradient(135deg, #064e3b 0%, #065f46 100%)' },
            { id: 'theme-4', name: 'Blood Moon', primary: '#f87171', accent: '#b91d1d', bg: '#450a0a', gradient: 'linear-gradient(135deg, #450a0a 0%, #7f1d1d 100%)', orbs: true },
            { id: 'theme-5', name: 'Cyberpunk', primary: '#00ffcc', accent: '#ff00ff', bg: '#1a1a2e', gradient: 'linear-gradient(135deg, #1a1a2e 0%, #2e1065 100%)', orbs: true },
            { id: 'theme-6', name: 'Crystal Light', primary: '#6366f1', accent: '#06b6d4', bg: '#f8fafc', gradient: 'linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%)', light: true, orbs: true },
            { id: 'theme-7', name: 'Snowy Peaks', primary: '#3b82f6', accent: '#93c5fd', bg: '#ffffff', gradient: 'linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%)', light: true },
            { id: 'theme-8', name: 'Rose Garden', primary: '#ec4899', accent: '#fbcfe8', bg: '#fff1f2', gradient: 'linear-gradient(135deg, #fff1f2 0%, #ffe4e6 100%)', light: true, orbs: true },
            { id: 'theme-9', name: 'Morning Mist', primary: '#14b8a6', accent: '#99f6e4', bg: '#f0fdfa', gradient: 'linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%)', light: true },
            { id: 'theme-10', name: 'Aurora Light', primary: '#10b981', accent: '#a7f3d0', bg: '#f0fdf4', gradient: 'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)', light: true, orbs: true }
        ];

        const timezones = Intl.supportedValuesOf('timeZone').map(tz => {
            const now = new Date();
            const offset = now.toLocaleTimeString('en-US', { timeZone: tz, timeZoneName: 'shortOffset' }).split(' ').pop();
            return { label: `(${offset}) ${tz.replace(/_/g, ' ')}`, value: tz };
        }).sort((a, b) => a.label.localeCompare(b.label));

        let myCompany = null;
        async function loadSettings() {
            const tzSel = document.getElementById('set-co-tz');
            if (tzSel && !tzSel.options.length) {
                tzSel.innerHTML = timezones.map(t => `<option value="${t.value}">${t.label}</option>`).join('');
            }

            const { data: co, error } = await sb.from('companies').select('*').eq('id', myProfile.company_id).single();
            if (error || !co) return console.error('Load Co Error:', error);
            myCompany = co;

            document.getElementById('set-co-name').value = co.name || '';
            document.getElementById('set-co-logo').value = co.logo_url || '';
            document.getElementById('set-co-tz').value = co.timezone || 'UTC';

            renderThemeGrid(co.theme_id || 'theme-1');
            updatePreview();
        }

        function renderThemeGrid(activeId) {
            const grid = document.getElementById('theme-grid');
            grid.innerHTML = themes.map(t => `
                <div onclick="previewTheme('${t.id}')" class="group cursor-pointer space-y-2">
                    <div class="w-full aspect-square rounded-xl border-2 transition-all overflow-hidden relative ${t.id === activeId ? 'border-violet-500 scale-105 shadow-lg' : 'border-white/5 hover:border-white/20'}" style="background:${t.bg}">
                        <div class="absolute inset-0 opacity-40" style="background:${t.gradient}"></div>
                        <div class="absolute bottom-2 right-2 w-3 h-3 rounded-full" style="background:${t.accent}"></div>
                        <div class="absolute top-2 left-2 w-5 h-1 rounded-full" style="background:${t.primary}"></div>
                    </div>
                    <div class="text-[10px] text-center font-bold tracking-tighter uppercase ${t.id === activeId ? 'text-violet-400' : 'text-white/40 group-hover:text-white/60'}">${t.name}</div>
                </div>
            `).join('');
            selectedThemeId = activeId;
        }

        let selectedThemeId = 'theme-1';
        function previewTheme(id) {
            selectedThemeId = id;
            renderThemeGrid(id);
            updatePreview();
        }

        function updatePreview() {
            const name = document.getElementById('set-co-name').value || 'Company Name';
            const logo = document.getElementById('set-co-logo').value;
            const theme = themes.find(t => t.id === selectedThemeId);

            document.getElementById('preview-co-name').textContent = name;
            const logoBox = document.getElementById('preview-logo-box');
            if (logo) logoBox.innerHTML = `<img src="${logo}" class="w-full h-full object-contain" />`;
            else logoBox.innerHTML = `<svg class="w-8 h-8 text-white/20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>`;

            const box = document.getElementById('preview-box');
            box.style.background = theme.bg;
            box.style.borderColor = theme.accent + '33';
            document.getElementById('theme-orbs').className = theme.orbs ? 'block' : 'hidden';

            // Apply live change to Sidebar/Topbar for immediate feedback
            document.getElementById('sb-company').textContent = name;
            document.getElementById('company-tag').textContent = name;
            applyTheme(theme);
        }

        function applyTheme(theme) {
            document.documentElement.style.setProperty('--primary', theme.primary);
            document.documentElement.style.setProperty('--accent', theme.accent);
            document.documentElement.style.setProperty('--bg', theme.bg);

            document.getElementById('dynamic-theme')?.remove();
            document.getElementById('early-theme')?.remove();

            if (theme.orbs) document.body.classList.add('with-orbs');
            else document.body.classList.remove('with-orbs');

            const style = document.createElement('style');
            style.id = 'dynamic-theme';
            const isLight = theme.light === true;
            style.innerHTML = `
                body { background: ${theme.gradient || theme.bg} fixed !important; color: ${isLight ? '#1e293b' : '#e2e8f0'} !important; }
                #sidebar { background: ${isLight ? 'rgba(255,255,255,0.7)' : theme.bg + 'cc'} !important; border-right: 1px solid ${isLight ? 'rgba(0,0,0,0.05)' : 'rgba(255,255,255,0.05)'} !important; backdrop-filter: blur(12px); }
                #top-bar { background: ${isLight ? 'rgba(255,255,255,0.8)' : theme.bg + 'e6'} !important; }
                .card, .stat-card, .modal, .composer-area, .notif-preview { background: ${isLight ? 'rgba(255,255,255,0.6)' : 'rgba(255,255,255,0.04)'} !important; border-color: ${isLight ? 'rgba(0,0,0,0.05)' : theme.accent + '15'} !important; }
                .input, select, textarea { background: ${isLight ? 'rgba(255,255,255,0.9)' : 'rgba(255,255,255,0.05)'} !important; color: ${isLight ? '#000' : '#fff'} !important; border-color: ${isLight ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)'} !important; }
                .text-white { color: ${isLight ? '#0f172a' : '#fff'} !important; }
                ${isLight ? `
                .text-white\\/70 { color: rgba(15, 23, 42, 0.7) !important; }
                .text-white\\/60 { color: rgba(15, 23, 42, 0.6) !important; }
                .text-white\\/40 { color: rgba(15, 23, 42, 0.4) !important; }
                .text-white\\/25 { color: rgba(15, 23, 42, 0.25) !important; }
                .text-white\\/20 { color: rgba(15, 23, 42, 0.2) !important; }
                .text-white\\/10 { color: rgba(15, 23, 42, 0.1) !important; }
                th { color: rgba(15, 23, 42, 0.5) !important; }
                .nav-item { color: #334155 !important; }
                .nav-item:hover { background: rgba(0,0,0,0.04) !important; }
                .nav-item.active { background: white !important; box-shadow: 0 4px 12px rgba(0,0,0,0.05) !important; color: var(--primary) !important; }
                ` : ''}
            `;
            document.head.appendChild(style);
        }

        async function uploadCoLogo(input) {
            const file = input.files[0];
            if (!file) return;
            const path = `logos/${myProfile.company_id}/${Date.now()}_logo`;
            const { error } = await sb.storage.from('avatars').upload(path, file);
            if (error) return alert('Logo upload failed');
            const { data: pub } = sb.storage.from('avatars').getPublicUrl(path);
            document.getElementById('set-co-logo').value = pub.publicUrl;
            updatePreview();
        }

        async function saveSettings() {
            const btn = document.getElementById('save-settings-btn');
            const msg = document.getElementById('settings-msg');
            btn.disabled = true;
            btn.textContent = 'Saving…';

            const updates = {
                name: document.getElementById('set-co-name').value.trim(),
                logo_url: document.getElementById('set-co-logo').value.trim(),
                timezone: document.getElementById('set-co-tz').value,
                theme_id: selectedThemeId
            };

            const { error } = await sb.from('companies').update(updates).eq('id', myProfile.company_id);

            msg.className = error ? 'text-red-400 bg-red-400/10' : 'text-emerald-400 bg-emerald-400/10';
            msg.className += ' text-sm rounded-xl px-4 py-3 mt-6';
            msg.textContent = error ? 'Error: ' + error.message : '✅ Settings saved successfully!';
            msg.classList.remove('hidden');

            btn.disabled = false;
            btn.textContent = 'Save Identity';
            if (!error) {
                myCompany = { ...myCompany, ...updates };
                setTimeout(() => msg.classList.add('hidden'), 5000);
            }
        }

        // ── BULK ACTIONS ──
        let currentBulkType = null;
        function updateBulkBar() {
            const sections = ['staff', 'notif', 'wall'];
            const activeSection = document.querySelector('.section.active').id.replace('section-', '');
            const checks = document.querySelectorAll(`.${activeSection}-checkbox:checked`);
            const bar = document.getElementById('bulk-bar');

            if (checks.length > 0) {
                currentBulkType = activeSection;
                document.getElementById('bulk-count').textContent = checks.length;
                bar.classList.add('show');
                // Adjust manage button visibility
                document.getElementById('bulk-manage-btn').style.display = (activeSection === 'staff') ? 'flex' : 'none';
            } else {
                bar.classList.remove('show');
                currentBulkType = null;
            }
        }

        function toggleAll(type) {
            const master = document.getElementById(`${type}-select-all`);
            document.querySelectorAll(`.${type}-checkbox`).forEach(c => c.checked = master.checked);
            updateBulkBar();
        }

        function clearSelection() {
            document.querySelectorAll('.bulk-item-check').forEach(c => c.checked = false);
            updateBulkBar();
        }

        async function bulkDelete() {
            if (!currentBulkType) return;
            const activeSection = document.querySelector('.section.active').id.replace('section-', '');
            const checks = document.querySelectorAll(`.${activeSection}-checkbox:checked`);
            const ids = Array.from(checks).map(c => c.value);

            if (ids.length === 0) return alert('Please select items to delete first.');
            if (!confirm(`Are you sure you want to delete ${ids.length} selected items? This action cannot be undone.`)) return;

            const table = activeSection === 'staff' ? 'profiles' : (activeSection === 'notifs' ? 'notifications' : 'posts');

            try {
                console.log('Bulk Deleting:', table, ids);
                const { error } = await sb.from(table).delete().in('id', ids);

                if (error) {
                    console.error('Bulk Delete DB Error:', error);
                    alert('Bulk Delete failed: ' + error.message);
                } else {
                    alert('✅ Successfully deleted ' + ids.length + ' items.');
                    clearSelection();
                    if (activeSection === 'staff') await loadStaff();
                    else if (activeSection === 'notifs') await loadNotifs();
                    else if (activeSection === 'wall') await loadWall();
                }
            } catch (err) {
                console.error('Bulk Delete Exception:', err);
                alert('An unexpected error occurred during deletion.');
            }
        }

        async function bulkManage() {
            if (currentBulkType !== 'staff') return;
            const checks = document.querySelectorAll('.staff-checkbox:checked');
            const ids = Array.from(checks).map(c => c.value);
            const action = prompt("Bulk Manage Staff:\nType 'suspend' to pause accounts\nType 'active' to resume accounts");

            if (!action) return;
            const isSuspended = action.toLowerCase() === 'suspend';
            if (!isSuspended && action.toLowerCase() !== 'active') return alert('Invalid action');

            const { error } = await sb.from('profiles').update({ is_suspended: isSuspended }).in('id', ids);
            if (error) alert('Error: ' + error.message);
            else {
                clearSelection();
                await loadStaff();
            }
        }

        async function loadMyProfile() {
            document.getElementById('my-profile-name').textContent = myProfile.full_name || myProfile.username;
            document.getElementById('my-set-name').value = myProfile.full_name || '';
            document.getElementById('my-old-pass').value = '';
            document.getElementById('my-new-pass').value = '';

            const av = document.getElementById('my-profile-avatar');
            if (myProfile.avatar_url) av.innerHTML = `<img src="${myProfile.avatar_url}" class="w-full h-full object-cover">`;
            else av.textContent = initials(myProfile.full_name || myProfile.username);
        }

        async function updateMyProfile() {
            const btn = document.getElementById('save-profile-btn');
            const msg = document.getElementById('profile-msg');
            const newName = document.getElementById('my-set-name').value.trim();
            const oldPass = document.getElementById('my-old-pass').value;
            const newPass = document.getElementById('my-new-pass').value;
            const newAv = document.getElementById('my-new-avatar').value;

            if (!newName) return alert('Name cannot be empty');

            // Password change check
            if (newPass && oldPass !== myProfile.password) {
                alert('Current password verification failed.');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Saving…';

            const updates = { full_name: newName };
            if (newPass) updates.password = newPass;
            if (newAv) updates.avatar_url = newAv;

            const { data, error } = await sb.from('profiles').update(updates).eq('id', myUser.id).select().single();

            if (error) {
                alert('Profile update failed: ' + error.message);
            } else {
                myProfile = data;
                myUser = data;
                localStorage.setItem('office_hub_user', JSON.stringify(data));

                // Refresh UI
                const n = data.full_name || data.username;
                document.getElementById('sb-name').textContent = n;
                const sbAv = document.getElementById('sb-avatar');
                if (data.avatar_url) sbAv.innerHTML = `<img src="${data.avatar_url}" class="w-full h-full rounded-full object-cover">`;
                else sbAv.textContent = initials(n);

                document.getElementById('my-profile-name').textContent = n;
                const av = document.getElementById('my-profile-avatar');
                if (data.avatar_url) av.innerHTML = `<img src="${data.avatar_url}" class="w-full h-full object-cover">`;

                msg.textContent = '✅ Profile updated successfully!';
                msg.classList.remove('hidden');
                setTimeout(() => msg.classList.add('hidden'), 3000);
            }
            btn.disabled = false;
            btn.textContent = 'Save Profile Changes';
        }
        async function init() {
            const userStr = localStorage.getItem('office_hub_user');
            if (!userStr) { window.location.href = 'index.html'; return }
            const localUser = JSON.parse(userStr);

            // ── 1. Fast auth: fetch profile only ──────────────────────
            const { data: profile } = await sb.from('profiles')
                .select('*, companies(*)')
                .eq('id', localUser.id)
                .single();
            if (!profile || (profile.role !== 'admin' && profile.role !== 'super_admin')) {
                window.location.href = 'staff.html'; return;
            }

            const impCoId = sessionStorage.getItem('office_hub_impersonate');
            if (profile.role === 'super_admin' && impCoId) {
                const { data: impCo } = await sb.from('companies').select('*').eq('id', impCoId).single();
                if (impCo) {
                    profile.company_id = impCo.id;
                    profile.companies = impCo;
                    document.getElementById('stop-imp-btn')?.classList.remove('hidden');
                }
            }

            myProfile = profile;
            myUser = profile;
            myCompany = profile.companies;

            localStorage.setItem('office_hub_user', JSON.stringify(profile));

            // ── 2. Apply theme immediately — no awaiting ───────────────
            if (myCompany?.theme_id) {
                const theme = themes.find(t => t.id === myCompany.theme_id) || themes[0];
                applyTheme(theme);
            }

            // ── 3. Render sidebar UI instantly ─────────────────────────
            const n = profile.full_name || myUser.username;
            document.getElementById('sb-name').textContent = n;
            const sbAv = document.getElementById('sb-avatar');
            if (profile.avatar_url) sbAv.innerHTML = `<img src="${profile.avatar_url}" class="w-full h-full rounded-full object-cover">`;
            else sbAv.textContent = initials(n);

            const compAv = document.getElementById('composer-avatar');
            if (compAv) {
                if (profile.avatar_url) compAv.innerHTML = `<img src="${profile.avatar_url}" class="w-full h-full rounded-full object-cover">`;
                else compAv.textContent = initials(n);
            }

            const coName = myCompany?.name || '—';
            document.getElementById('sb-company').textContent = coName;
            document.getElementById('company-tag').textContent = coName;
            document.getElementById('company-tag').classList.remove('hidden');

            // Set default reports date to today
            const todayStr = new Date().toISOString().split('T')[0];
            const rptFrom = document.getElementById('rpt-from');
            const rptTo = document.getElementById('rpt-to');
            if (rptFrom) rptFrom.value = todayStr;
            if (rptTo) rptTo.value = todayStr;

            // ── 4. Subscription lock check (fast — only fetches company row)
            const co = myCompany;
            if (co) {
                const end = co.subscription_end_date ? new Date(co.subscription_end_date) : null;
                const daysLeft = end ? Math.ceil((end - new Date()) / (1000 * 60 * 60 * 24)) : 0;
                const graceDays = co.grace_period_days || 3;
                isCompanyLocked = daysLeft < -graceDays;
            }

            // ── 5. Show the correct section IMMEDIATELY ────────────────
            if (isCompanyLocked) {
                show('sub');
            } else {
                show('dash');
            }

            // ── 6. Kick off secondary data loads in parallel (non-blocking)
            loadStaff(); // needed for stats

            // ── 7. Setup realtime subscriptions ───────────────────────
            sb.channel('company-settings')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'companies', filter: `id=eq.${myProfile.company_id}` }, payload => {
                    myCompany = payload.new;
                    const theme = themes.find(t => t.id === myCompany.theme_id) || themes[0];
                    applyTheme(theme);
                    document.getElementById('sb-company').textContent = myCompany.name;
                    document.getElementById('company-tag').textContent = myCompany.name;
                })
                .subscribe();

            sb.channel('admin-profiles-refresh')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles', filter: `company_id=eq.${myProfile.company_id}` }, () => {
                    loadStaff();
                })
                .subscribe();

            sb.channel('admin-security')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'profiles', filter: `id=eq.${myUser.id}` }, payload => {
                    if (payload.new.is_suspended) logout();
                    const localSid = localStorage.getItem('office_hub_session');
                    if (payload.new.session_id && localSid && payload.new.session_id !== localSid) {
                        alert('Multiple devices detected. Logging out.');
                        logout();
                    }
                })
                .subscribe();

            // ── 8. Clock ───────────────────────────────────────────────
            setInterval(() => {
                const tz = myCompany?.timezone || 'UTC';
                const timeStr = new Date().toLocaleTimeString('en-US', {
                    hour: '2-digit', minute: '2-digit', timeZone: tz
                });
                const timeEl = document.getElementById('topbar-time');
                if (timeEl) timeEl.textContent = timeStr;
            }, 1000);
        }

        function applyTheme(theme) {
            document.documentElement.style.setProperty('--primary', theme.primary);
            document.documentElement.style.setProperty('--accent', theme.accent);
            document.documentElement.style.setProperty('--bg', theme.bg);

            document.getElementById('dynamic-theme')?.remove();
            document.getElementById('early-theme')?.remove();

            if (theme.orbs) document.body.classList.add('with-orbs');
            else document.body.classList.remove('with-orbs');

            const isLight = theme.light === true;
            const style = document.createElement('style');
            style.id = 'dynamic-theme';
            style.innerHTML = `
                body { background: ${theme.gradient || theme.bg} fixed !important; color: ${isLight ? '#1e293b' : '#e2e8f0'} !important; }
                #sidebar { background: ${isLight ? 'rgba(255,255,255,0.7)' : theme.bg + 'cc'} !important; border-right-color: ${isLight ? 'rgba(0,0,0,0.05)' : theme.primary + '22'} !important; }
                #top-bar { background: ${isLight ? 'rgba(255,255,255,0.7)' : theme.bg + 'cc'} !important; border-bottom-color: ${isLight ? 'rgba(0,0,0,0.05)' : theme.primary + '1a'} !important; backdrop-filter: blur(12px) !important; }
                .card, .stat-card, .modal { background: ${isLight ? 'rgba(255,255,255,0.6)' : 'rgba(255,255,255,0.04)'} !important; border-color: ${isLight ? 'rgba(0,0,0,0.05)' : theme.accent + '15'} !important; color: ${isLight ? '#1e293b' : '#e2e8f0'} !important; }
                .text-white, h1, h2, h3, .font-semibold { color: ${isLight ? '#0f172a' : '#fff'} !important; }
                .text-white\\/40, .text-white\\/50, .text-white\\/60, .text-white\\/70 { color: ${isLight ? 'rgba(0,0,0,0.5)' : 'rgba(255,255,255,0.5)'} !important; }
                .nav-item { color: ${isLight ? 'rgba(0,0,0,0.6)' : 'rgba(255,255,255,0.55)'} !important; }
                .nav-item:hover { background: ${theme.primary}15 !important; color: ${theme.primary} !important; }
                .nav-item.active { background: ${theme.primary}1a !important; color: ${theme.primary} !important; }
                #sidebar-name, #page-title, #sb-name { color: ${isLight ? '#0f172a' : '#fff'} !important; }
                input, select, textarea { background: ${isLight ? 'rgba(255,255,255,0.9)' : 'rgba(255,255,255,0.05)'} !important; color: ${isLight ? '#000' : '#fff'} !important; border-color: ${isLight ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)'} !important; }
                .badge-admin, .badge-staff, .badge-in, .badge-out, .badge-break { border-width: 1px !important; }
            `;
            document.head.appendChild(style);
        }

        function getRange(type, sId, eId) {
            const now = new Date();
            let start = null, end = null;
            if (type === 'all') return { start, end };

            start = new Date();
            start.setHours(0, 0, 0, 0);
            end = new Date();
            end.setHours(23, 59, 59, 999);

            if (type === 'week') {
                const day = now.getDay() || 7;
                start.setDate(now.getDate() - day + 1);
            } else if (type === 'month') {
                start.setDate(1);
            } else if (type === 'year') {
                start.setMonth(0, 1);
            } else if (type === 'custom') {
                const s = document.getElementById(sId).value;
                const e = document.getElementById(eId).value;
                if (s) { start = new Date(s); start.setHours(0, 0, 0, 0); } else start = null;
                if (e) { end = new Date(e); end.setHours(23, 59, 59, 999); } else end = null;
            }
            return { start, end };
        }

        function openStaffDetail(id) {
            const u = myStaff.find(x => x.id === id);
            if (!u) return;

            const initials = (name) => {
                if (!name) return '—';
                return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
            };

            const panel = document.getElementById('staff-detail-panel');
            const overlay = document.getElementById('staff-detail-overlay');
            const content = document.getElementById('staff-detail-content');

            content.innerHTML = `
                <div class="sdp-header">
                    <button onclick="closeStaffDetail()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-white/5 flex items-center justify-center hover:bg-white/10 transition-colors">
                        <svg class="w-4 h-4 text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                    <div class="flex items-center gap-4">
                        <div class="sdp-avatar">
                            ${u.avatar_url ? `<img src="${u.avatar_url}" alt="">` : initials(u.full_name)}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-white font-bold text-lg truncate">${esc(u.full_name || 'No Name')}</h3>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="badge ${u.role === 'admin' ? 'badge-admin' : 'badge-staff'} text-[10px] py-0.5 px-2">${u.role}</span>
                                ${(String(u.is_suspended) === 'true') ? `<span class="bg-red-500/20 text-red-400 text-[9px] font-bold px-2 py-0.5 rounded border border-red-500/30">SUSPENDED</span>` : `<span class="bg-emerald-500/20 text-emerald-400 text-[9px] font-bold px-2 py-0.5 rounded border border-emerald-500/30">ACTIVE</span>`}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sdp-body custom-scrollbar">
                    <div class="sdp-row">
                        <div class="sdp-icon">👤</div>
                        <div class="flex-1">
                            <div class="sdp-label">Username</div>
                            <div class="sdp-value">${esc(u.username || '—')}</div>
                        </div>
                    </div>
                    <div class="sdp-row">
                        <div class="sdp-icon">📅</div>
                        <div class="flex-1">
                            <div class="sdp-label">Joined On</div>
                            <div class="sdp-value">${new Date(u.created_at).toLocaleDateString(undefined, { dateStyle: 'long' })}</div>
                        </div>
                    </div>
                    <div class="sdp-row">
                        <div class="sdp-icon">💵</div>
                        <div class="flex-1">
                            <div class="sdp-label">Salary / Compensation</div>
                            <div class="sdp-value">${esc(u.salary || 'Not set')}</div>
                        </div>
                    </div>
                    <div class="sdp-row">
                        <div class="sdp-icon">⏰</div>
                        <div class="flex-1">
                            <div class="sdp-label">Duty Time</div>
                            <div class="sdp-value">${esc(u.duty_time || 'Not set')}</div>
                        </div>
                    </div>
                    <div class="sdp-row" style="border-bottom:none">
                        <div class="sdp-icon">📝</div>
                        <div class="flex-1">
                            <div class="sdp-label">Internal Notes</div>
                            <div class="sdp-value ${u.custom_note ? '' : 'muted'}">${esc(u.custom_note || 'No notes added for this staff member.')}</div>
                        </div>
                    </div>
                </div>

                <div class="sdp-footer">
                    <button onclick="closeStaffDetail(); openEditStaff('${u.id}')" class="btn btn-primary flex-1 py-2 text-sm justify-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                        Edit Profile
                    </button>
                    <button onclick="closeStaffDetail(); deleteUser('${u.id}')" class="btn btn-danger py-2 px-3">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    </button>
                </div>
            `;

            panel.classList.add('open');
            overlay.classList.add('open');
            document.body.style.overflow = 'hidden'; // Lock background scroll
        }

        function closeStaffDetail() {
            document.getElementById('staff-detail-panel').classList.remove('open');
            document.getElementById('staff-detail-overlay').classList.remove('open');
            document.body.style.overflow = '';
        }

        async function logout() {
            localStorage.removeItem('office_hub_user');
            sessionStorage.removeItem('office_hub_impersonate');
            window.location.href = 'index.html';
        }
        function stopImpersonating() {
            sessionStorage.removeItem('office_hub_impersonate');
            window.location.href = 'superadmin.html';
        }
        init();
    </script>
    <div id="staff-detail-overlay" onclick="closeStaffDetail()"></div>
    <div id="staff-detail-panel">
        <div id="staff-detail-content" class="h-full flex flex-col">
            <!-- Details loaded via JS -->
        </div>
    </div>

</body>

</html>